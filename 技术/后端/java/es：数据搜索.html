<!DOCTYPE html>
<html><head>
<title>ES：数据搜索</title>
<base href="../../..">
<meta id="root-path" root-path="../../..">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
<meta charset="UTF-8">
<meta name="description" content="尘影迹痕 - ES：数据搜索">
<meta property="og:title" content="ES：数据搜索">
<meta property="og:description" content="尘影迹痕 - ES：数据搜索">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.cytl2.eu.org/技术/后端/java/es：数据搜索.html">
<meta property="og:image" content="https://i0.hdslb.com/bfs/album/e87749382031b0f2004792690313323ee455c304.png">
<meta property="og:site_name" content="尘影迹痕">
<meta name="author" content="lzy"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://blog.cytl2.eu.org/lib/rss.xml"></head><body class="publish css-settings-manager theme-light show-inline-title h2-underline tbMH-yuan tbMH-qk tbMH-ds-cg tbMH-kd-ncc-jy is-focused"><include src="lib/html/custom-head-content.html"></include><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.svg"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript><link rel="preload" href="lib/styles/snippets.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/snippets.css"></noscript><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:not(h1,h2,h3,h4,h5,h6):has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(const t of e){let e=t.getAttribute("src");try{const o=await fetch(e);if(!o.ok){console.log("Could not include file: "+e),t?.remove();continue}let l=await o.text(),n=document.createRange().createContextualFragment(l),c=Array.from(n.children);for(let e of c)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);t.before(n),t.remove(),console.log("Included file: "+e)}catch(o){t?.remove(),console.log("Could not include file: "+e,o);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="1.DSL查询文档"><p>1.DSL查询文档</p></h1><div><p>在昨天的学习中，我们已经导入了大量数据到elasticsearch中，实现了elasticsearch的数据存储功能。但elasticsearch最擅长的还是搜索和数据分析。</p></div><div><p>所以今天，我们研究下elasticsearch的数据搜索功能。我们会分别使用<strong>DSL</strong>和<strong>RestClient</strong>实现搜索。</p></div><div class="heading-wrapper"><div class="heading-children"><div><p>elasticsearch的查询依然是基于JSON风格的DSL来实现的。</p></div><div class="heading-wrapper"><h2 data-heading="1.1.DSL查询分类" class="heading" id="1.1.DSL查询分类"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.1.DSL查询分类</h2><div class="heading-children"><div><p>Elasticsearch提供了基于JSON的DSL（<a data-tooltip-position="top" aria-label="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="noopener" class="external-link is-unresolved" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" target="_self">Domain Specific Language</a>）来定义查询。常见的查询类型包括：</p></div><div><ul>
<li data-line="0">
<p><strong>查询所有</strong>：查询出所有数据，一般测试用。例如：match_all</p>
</li>
<li data-line="2"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>全文检索（full text）查询</strong>：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：</p>
<ul>
<li data-line="3">match_query</li>
<li data-line="4">multi_match_query</li>
</ul>
</li>
<li data-line="5"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>精确查询</strong>：根据精确词条值查找数据，一般是查找keyword、数值、日期、boolean等类型字段。例如：</p>
<ul>
<li data-line="6">ids</li>
<li data-line="7">range</li>
<li data-line="8">term</li>
</ul>
</li>
<li data-line="9"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>地理（geo）查询</strong>：根据经纬度查询。例如：</p>
<ul>
<li data-line="10">geo_distance</li>
<li data-line="11">geo_bounding_box</li>
</ul>
</li>
<li data-line="12"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>复合（compound）查询</strong>：复合查询可以将上述各种查询条件组合起来，合并查询条件。例如：</p>
<ul>
<li data-line="13">bool</li>
<li data-line="14">function_score</li>
</ul>
</li>
</ul></div><div><p>查询的语法基本一致：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"查询类型"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"查询条件"</span><span class="token operator">:</span> <span class="token string">"条件值"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>我们以查询所有为例，其中：</p></div><div><ul>
<li data-line="0">查询类型为match_all</li>
<li data-line="1">没有查询条件</li>
</ul></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// 查询所有</span>
GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>其它查询无非就是<strong>查询类型</strong>、<strong>查询条件</strong>的变化。</p></div></div></div><div class="heading-wrapper"><h2 data-heading="1.2.全文检索查询" class="heading" id="1.2.全文检索查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.全文检索查询</h2><div class="heading-children"><div class="heading-wrapper"><h3 data-heading="1.2.1.使用场景" class="heading" id="1.2.1.使用场景"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.1.使用场景</h3><div class="heading-children"><div><p>全文检索查询的基本流程如下：</p></div><div><ul>
<li data-line="0">对用户搜索的内容做分词，得到词条</li>
<li data-line="1">根据词条去倒排索引库中匹配，得到文档id</li>
<li data-line="2">根据文档id找到文档，返回给用户</li>
</ul></div><div><p>比较常用的场景包括：</p></div><div><ul>
<li data-line="0">商城的输入框搜索</li>
<li data-line="1">百度输入框搜索</li>
</ul></div><div><p>例如京东：</p></div><div><p><img alt="image-20210721165326938" src="https://i0.hdslb.com/bfs/album/e87749382031b0f2004792690313323ee455c304.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>因为是拿着词条去匹配，因此参与搜索的字段也必须是可分词的text类型的字段。</p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.2.2.基本语法" class="heading" id="1.2.2.基本语法"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.2.基本语法</h3><div class="heading-children"><div><p>常见的全文检索查询包括：</p></div><div><ul>
<li data-line="0">match查询：单字段查询</li>
<li data-line="1">multi_match查询：多字段查询，任意一个字段符合条件就算符合查询条件</li>
</ul></div><div><p>match查询语法如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>mulit_match语法如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span><span class="token punctuation">,</span>
      <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"FIELD1"</span><span class="token punctuation">,</span> <span class="token string">" FIELD12"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="1.2.3.示例" class="heading" id="1.2.3.示例"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.3.示例</h3><div class="heading-children"><div><p>match查询示例：</p></div><div><p><img alt="image-20210721170455419" src="https://i0.hdslb.com/bfs/album/bb6eaecae782b0f6f71a33dcd501bacd35f5cadc.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>multi_match查询示例：</p></div><div><p><img alt="image-20210721170720691" src="https://i0.hdslb.com/bfs/album/0dc79636901c720a7ede713818b2686916867ad6.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>可以看到，两种查询结果是一样的，为什么？</p></div><div><p>因为我们将brand、name、business值都利用copy_to复制到了all字段中。因此你根据三个字段搜索，和根据all字段搜索效果当然一样了。</p></div><div><p>但是，搜索字段越多，对查询性能影响越大，因此建议采用copy_to，然后单字段查询的方式。</p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.2.4.总结" class="heading" id="1.2.4.总结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.4.总结</h3><div class="heading-children"><div><p>match和multi_match的区别是什么？</p></div><div><ul>
<li data-line="0">match：根据一个字段查询</li>
<li data-line="1">multi_match：根据多个字段查询，参与查询字段越多，查询性能越差</li>
</ul></div><div><p><strong>建议使用</strong>“copy_to”将要查询的字段拷贝到一个叫“all”的字段使用match查询</p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="1.3.精准查询" class="heading" id="1.3.精准查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.精准查询</h2><div class="heading-children"><div><p>精确查询一般是查找keyword、数值、日期、boolean等类型字段。所以<strong>不会</strong>对搜索条件分词。常见的有：</p></div><div><ul>
<li data-line="0">term：根据词条精确值查询</li>
<li data-line="1">range：根据值的范围查询</li>
</ul></div><div class="heading-wrapper"><h3 data-heading="1.3.1.term查询" class="heading" id="1.3.1.term查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.1.term查询</h3><div class="heading-children"><div><p>因为精确查询的字段搜是不分词的字段，因此查询的条件也必须是<strong>不分词</strong>的词条。查询时，用户输入的内容跟自动值完全匹配时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据。</p></div><div><p>语法说明：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// term查询</span>
GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"VALUE"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>示例：</p></div><div><p>当我搜索的是精确词条时，能正确查询出结果：</p></div><div><p><img alt="image-20210721171655308" src="https://i0.hdslb.com/bfs/album/0ca70a57a29a413f5545798874f2a4d9bad6144b.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>但是，当我搜索的内容不是词条，而是多个词语形成的短语时，反而搜索不到：</p></div><div><p><img alt="image-20210721171838378" src="https://i0.hdslb.com/bfs/album/a535f55da48393fd232c795a6e4c0afb066457d1.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.3.2.range查询" class="heading" id="1.3.2.range查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.2.range查询</h3><div class="heading-children"><div><p>范围查询，一般应用在对数值类型做范围过滤的时候。比如做价格范围过滤。</p></div><div><p>基本语法：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// range查询</span>
GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 这里的gte代表大于等于，gt则代表大于</span>
        <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// lte代表小于等于，lt则代表小于</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>示例：</p></div><div><p><img alt="image-20210721172307172" src="https://i0.hdslb.com/bfs/album/9dd92c32dca853af29ab83f843788f77eac339db.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.3.3.总结" class="heading" id="1.3.3.总结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.3.总结</h3><div class="heading-children"><div><p>精确查询常见的有哪些？</p></div><div><ul>
<li data-line="0">term查询：根据词条精确匹配，一般搜索keyword类型、数值类型、布尔类型、日期类型字段</li>
<li data-line="1">range查询：根据数值范围查询，可以是数值、日期的范围</li>
</ul></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="1.4.地理坐标查询" class="heading" id="1.4.地理坐标查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4.地理坐标查询</h2><div class="heading-children"><div><p>所谓的地理坐标查询，其实就是根据经纬度查询，官方文档：<a rel="noopener" class="external-link is-unresolved" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html" target="_self">https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html</a></p></div><div><p>常见的使用场景包括：</p></div><div><ul>
<li data-line="0">携程：搜索我附近的酒店</li>
<li data-line="1">滴滴：搜索我附近的出租车</li>
<li data-line="2">微信：搜索我附近的人</li>
</ul></div><div><p>附近的酒店：</p></div><div><p><img alt="image-20210721172645103" src="https://i0.hdslb.com/bfs/album/341fdd37f47158e7756fca7c70c4aa78ab9b4e6b.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div><div><p>附近的车：</p></div><div><p><img alt="image-20210721172654880" src="https://i0.hdslb.com/bfs/album/883b186738eac790a6a0a1c792cd809fdf508487.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div><div class="heading-wrapper"><h3 data-heading="1.4.1.矩形范围查询" class="heading" id="1.4.1.矩形范围查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4.1.矩形范围查询</h3><div class="heading-children"><div><p>矩形范围查询，也就是geo_bounding_box查询，查询坐标落在某个矩形范围的所有文档：</p></div><div><p><img alt="DKV9HZbVS6" src="https://i0.hdslb.com/bfs/album/885a04cba43c099240fa6433d5f5876e2df170bf.gif" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>查询时，需要指定矩形的<strong>左上</strong>、<strong>右下</strong>两个点的坐标，然后画出一个矩形，落在该矩形内的都是符合条件的点。</p></div><div><p>语法如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// geo_bounding_box查询</span>
GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"geo_bounding_box"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"top_left"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 左上点</span>
          <span class="token property">"lat"</span><span class="token operator">:</span> <span class="token number">31.1</span><span class="token punctuation">,</span>
          <span class="token property">"lon"</span><span class="token operator">:</span> <span class="token number">121.5</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"bottom_right"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 右下点</span>
          <span class="token property">"lat"</span><span class="token operator">:</span> <span class="token number">30.9</span><span class="token punctuation">,</span>
          <span class="token property">"lon"</span><span class="token operator">:</span> <span class="token number">121.7</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>这种并不符合“附近的人”这样的需求，所以我们就不做了。</p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.4.2.附近查询" class="heading" id="1.4.2.附近查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4.2.附近查询</h3><div class="heading-children"><div><p>附近查询，也叫做距离查询（geo_distance）：查询到指定中心点小于某个距离值的所有文档。</p></div><div><p>换句话来说，在地图上找一个点作为圆心，以指定距离为半径，画一个圆，落在圆内的坐标都算符合条件：</p></div><div><p><img alt="vZrdKAh19C" src="https://i0.hdslb.com/bfs/album/d19e5a39fe944889585fa24dd0a072e8ebee320b.gif" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>语法说明：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// geo_distance 查询</span>
GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"distance"</span><span class="token operator">:</span> <span class="token string">"15km"</span><span class="token punctuation">,</span> <span class="token comment">// 半径</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"31.21,121.5"</span> <span class="token comment">// 圆心</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>示例：</p></div><div><p>我们先搜索陆家嘴附近15km的酒店：</p></div><div><p><img alt="image-20210721175443234" src="https://i0.hdslb.com/bfs/album/354372ca5b1287b1f1fbe924a76873f34d4f1bec.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>发现共有47家酒店。</p></div><div><p>然后把半径缩短到3公里：</p></div><div><p><img alt="image-20210721182031475" src="https://i0.hdslb.com/bfs/album/e51c9e068d7694598bff276c738c58db775f37d8.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>可以发现，搜索到的酒店数量减少到了5家。</p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="1.5.复合查询" class="heading" id="1.5.复合查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.5.复合查询</h2><div class="heading-children"><div><p>复合（compound）查询：复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。常见的有两种：</p></div><div><ul>
<li data-line="0">fuction score：算分函数查询，可以控制文档相关性算分，控制文档排名</li>
<li data-line="1">bool query：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索</li>
</ul></div><div class="heading-wrapper"><h3 data-heading="1.5.1.相关性算分" class="heading" id="1.5.1.相关性算分"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.5.1.相关性算分</h3><div class="heading-children"><div><p>当我们利用match查询时，文档结果会根据与搜索词条的关联度打分（_score），返回结果时按照分值降序排列。</p></div><div><p>例如，我们搜索 "虹桥如家"，结果如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">17.850193</span><span class="token punctuation">,</span>
    <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"虹桥如家酒店真不错"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">12.259849</span><span class="token punctuation">,</span>
    <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"外滩如家酒店真不错"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">11.91091</span><span class="token punctuation">,</span>
    <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"迪士尼如家酒店真不错"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>在elasticsearch中，早期使用的打分算法是TF-IDF算法，公式如下：</p></div><div><p><img alt="image-20210721190152134" src="https://i0.hdslb.com/bfs/album/f117c651c56a3b28da08da6f976c0e7361ebd7dd.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>在后来的5.1版本升级中，elasticsearch将算法改进为BM25算法，公式如下：</p></div><div><p><img alt="image-20210721190416214" src="https://i0.hdslb.com/bfs/album/558c327ff76581513d1add716e8d13e5b8f4e322.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>TF-IDF算法有一各缺陷，就是词条频率越高，文档得分也会越高，单个词条对文档影响较大。而BM25则会让单个词条的算分有一个上限，曲线更加平滑：</p></div><div><p><img alt="image-20210721190907320" src="https://i0.hdslb.com/bfs/album/4cfb48a8ef7a3c2a8477eac38b6e6d24e33efd6c.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>小结：elasticsearch会根据词条和文档的相关度做打分，算法由两种：</p></div><div><ul>
<li data-line="0">TF-IDF算法</li>
<li data-line="1">BM25算法，elasticsearch5.1版本后采用的算法</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="1.5.2.算分函数查询" class="heading" id="1.5.2.算分函数查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.5.2.算分函数查询</h3><div class="heading-children"><div><p>根据相关度打分是比较合理的需求，但<strong>合理的不一定是产品经理需要</strong>的。</p></div><div><p>以百度为例，你搜索的结果中，并不是相关度越高排名越靠前，而是谁掏的钱多排名就越靠前。如图：</p></div><div><p><img alt="image-20210721191144560" src="https://i0.hdslb.com/bfs/album/aa865748db9b7fba080a149d48557fb78374e47d.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>要想认为控制相关性算分，就需要利用elasticsearch中的function score 查询了。</p></div><div class="heading-wrapper"><h4 data-heading="1）语法说明" class="heading" id="1）语法说明"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1）语法说明</h4><div class="heading-children"><div><p><img alt="image-20210721191544750" src="https://i0.hdslb.com/bfs/album/af246cc8f9471f1c98396b66c495eff96f745102.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>function score 查询中包含四部分内容：</p></div><div><ul>
<li data-line="0"><strong>原始查询</strong>条件：query部分，基于这个条件搜索文档，并且基于BM25算法给文档打分，<strong>原始算分</strong>（query score)</li>
<li data-line="1"><strong>过滤条件</strong>：filter部分，符合该条件的文档才会重新算分</li>
<li data-line="2"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><strong>算分函数</strong>：符合filter条件的文档要根据这个函数做运算，得到的<strong>函数算分</strong>（function score），有四种函数
<ul>
<li data-line="3">weight：函数结果是常量</li>
<li data-line="4">field_value_factor：以文档中的某个字段值作为函数结果</li>
<li data-line="5">random_score：以随机数作为函数结果</li>
<li data-line="6">script_score：自定义算分函数算法</li>
</ul>
</li>
<li data-line="7"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><strong>运算模式</strong>：算分函数的结果、原始查询的相关性算分，两者之间的运算方式，包括：
<ul>
<li data-line="8">multiply：相乘</li>
<li data-line="9">replace：用function score替换query score</li>
<li data-line="10">其它，例如：sum、avg、max、min</li>
</ul>
</li>
</ul></div><div><p>function score的运行流程如下：</p></div><div><ul>
<li data-line="0">1）根据<strong>原始条件</strong>查询搜索文档，并且计算相关性算分，称为<strong>原始算分</strong>（query score）</li>
<li data-line="1">2）根据<strong>过滤条件</strong>，过滤文档</li>
<li data-line="2">3）符合<strong>过滤条件</strong>的文档，基于<strong>算分函数</strong>运算，得到<strong>函数算分</strong>（function score）</li>
<li data-line="3">4）将<strong>原始算分</strong>（query score）和<strong>函数算分</strong>（function score）基于<strong>运算模式</strong>做运算，得到最终结果，作为相关性算分。</li>
</ul></div><div><p>因此，其中的关键点是：</p></div><div><ul>
<li data-line="0">过滤条件：决定哪些文档的算分被修改</li>
<li data-line="1">算分函数：决定函数算分的算法</li>
<li data-line="2">运算模式：决定最终算分结果</li>
</ul></div></div></div><div class="heading-wrapper"><h4 data-heading="2）示例" class="heading" id="2）示例"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2）示例</h4><div class="heading-children"><div><p>需求：给“如家”这个品牌的酒店排名靠前一些</p></div><div><p>翻译一下这个需求，转换为之前说的四个要点：</p></div><div><ul>
<li data-line="0">原始条件：不确定，可以任意变化</li>
<li data-line="1">过滤条件：brand = "如家"</li>
<li data-line="2">算分函数：可以简单粗暴，直接给固定的算分结果，weight</li>
<li data-line="3">运算模式：比如求和</li>
</ul></div><div><p>因此最终的DSL语句如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"function_score"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  .... <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 原始查询，可以是任意条件</span>
      <span class="token property">"functions"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 算分函数</span>
        <span class="token punctuation">{</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 满足的条件，品牌必须是如家</span>
            <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"如家"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"weight"</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token comment">// 算分权重为2</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"boost_mode"</span><span class="token operator">:</span> <span class="token string">"sum"</span> <span class="token comment">// 加权模式，求和</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>测试，在未添加算分函数时，如家得分如下：</p></div><div><p><img alt="image-20210721193152520" src="https://i0.hdslb.com/bfs/album/b3d4ead4b2a843de3e5e4960334d0969b2c512d9.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>添加了算分函数后，如家得分就提升了：</p></div><div><p><img alt="image-20210721193458182" src="https://i0.hdslb.com/bfs/album/1857afee029c01d105b361530694000890b96b9c.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h4 data-heading="3）小结" class="heading" id="3）小结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3）小结</h4><div class="heading-children"><div><p>function score query定义的三要素是什么？</p></div><div><ul>
<li data-line="0">过滤条件：哪些文档要加分</li>
<li data-line="1">算分函数：如何计算function score</li>
<li data-line="2">加权方式：function score 与 query score如何运算</li>
</ul></div></div></div></div></div><div class="heading-wrapper"><h3 data-heading="1.5.3.布尔查询" class="heading" id="1.5.3.布尔查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.5.3.布尔查询</h3><div class="heading-children"><div><p>布尔查询是一个或多个查询子句的组合，每一个子句就是一个<strong>子查询</strong>。子查询的组合方式有：</p></div><div><ul>
<li data-line="0">must：必须匹配每个子查询，类似“与”</li>
<li data-line="1">should：选择性匹配子查询，类似“或”</li>
<li data-line="2">must_not：必须不匹配，<strong>不参与算分</strong>，类似“非”</li>
<li data-line="3">filter：必须匹配，<strong>不参与算分</strong></li>
</ul></div><div><p>比如在搜索酒店时，除了关键字搜索外，我们还可能根据品牌、价格、城市等字段做过滤：</p></div><div><p><img alt="image-20210721193822848" src="https://i0.hdslb.com/bfs/album/16a9adf3bcf8e3c485202da427431dd673bcb8a6.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>每一个不同的字段，其查询的条件、方式都不一样，必须是多个不同的查询，而要组合这些查询，就必须用bool查询了。</p></div><div><p>需要注意的是，搜索时，参与<strong>打分的字段越多，查询的性能也越差</strong>。因此这种多条件查询时，建议这样做：</p></div><div><ul>
<li data-line="0">搜索框的关键字搜索，是全文检索查询，使用must查询，参与算分</li>
<li data-line="1">其它过滤条件，采用filter查询。不参与算分</li>
</ul></div><div class="heading-wrapper"><h4 data-heading="1）语法示例：" class="heading" id="1）语法示例："><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1）语法示例：</h4><div class="heading-children"><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"上海"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"should"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"皇冠假日"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华美达"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"must_not"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token number">45</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h4 data-heading="2）示例" class="heading" id="2）示例"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2）示例</h4><div class="heading-children"><div><p>需求：搜索名字包含“如家”，价格不高于400，在坐标31.21,121.5周围10km范围内的酒店。</p></div><div><p>分析：</p></div><div><ul>
<li data-line="0">名称搜索，属于全文检索查询，应该参与算分。放到must中</li>
<li data-line="1">价格不高于400，用range查询，属于过滤条件，不参与算分。放到must_not中</li>
<li data-line="2">周围10km范围内，用geo_distance查询，属于过滤条件，不参与算分。放到filter中</li>
</ul></div><div><p><img alt="image-20210721194744183" src="https://i0.hdslb.com/bfs/album/52033d21490f6b115481a0356ed728a1017b7555.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h4 data-heading="3）小结" class="heading" id="3）小结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3）小结</h4><div class="heading-children"><div><p>bool查询有几种逻辑关系？</p></div><div><ul>
<li data-line="0">must：必须匹配的条件，可以理解为“与”</li>
<li data-line="1">should：选择性匹配的条件，可以理解为“或”</li>
<li data-line="2">must_not：必须不匹配的条件，不参与打分</li>
<li data-line="3">filter：必须匹配的条件，不参与打分</li>
</ul></div><div><p><strong>一般来说关键字参与算分其他的不应该参与算分——参与算分的字段越多性能越差</strong></p></div></div></div></div></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="2.搜索结果处理" class="heading" id="2.搜索结果处理">2.搜索结果处理</h1><div class="heading-children"><div><p>搜索的结果可以按照用户指定的方式去处理或展示。</p></div><div class="heading-wrapper"><h2 data-heading="2.1.排序" class="heading" id="2.1.排序"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.1.排序</h2><div class="heading-children"><div><p>elasticsearch默认是根据相关度算分（_score）来排序，但是也支持自定义方式对搜索<a data-tooltip-position="top" aria-label="https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html" rel="noopener" class="external-link is-unresolved" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html" target="_self">结果排序</a>。可以排序字段类型有：keyword类型、数值类型、地理坐标类型、日期类型等。</p></div><div class="heading-wrapper"><h3 data-heading="2.1.1.普通字段排序" class="heading" id="2.1.1.普通字段排序"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.1.1.普通字段排序</h3><div class="heading-children"><div><p>keyword、数值、日期类型排序的语法基本一致。</p></div><div><p><strong>语法</strong>：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"desc"</span>  <span class="token comment">// 排序字段、排序方式ASC、DESC</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>排序条件是一个数组，也就是可以写多个排序条件。按照声明的顺序，当第一个条件相等时，再按照第二个条件排序，以此类推</p></div><div><p><strong>示例</strong>：</p></div><div><p>需求描述：酒店数据按照用户评价（score)降序排序，评价相同的按照价格(price)升序排序</p></div><div><p><img alt="image-20210721195728306" src="https://i0.hdslb.com/bfs/album/28439b028282ced1562c53d740f4b831ac4a2023.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="2.1.2.地理坐标排序" class="heading" id="2.1.2.地理坐标排序"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.1.2.地理坐标排序</h3><div class="heading-children"><div><p>地理坐标排序略有不同。</p></div><div><p><strong>语法说明</strong>：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"FIELD"</span> <span class="token operator">:</span> <span class="token string">"纬度，经度"</span><span class="token punctuation">,</span> <span class="token comment">// 文档中geo_point类型的字段名、目标坐标点</span>
          <span class="token property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span> <span class="token comment">// 排序方式</span>
          <span class="token property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span> <span class="token comment">// 排序的距离单位</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>这个查询的含义是：</p></div><div><ul>
<li data-line="0">指定一个坐标，作为目标点</li>
<li data-line="1">计算每一个文档中，指定字段（必须是geo_point类型）的坐标 到目标点的距离是多少</li>
<li data-line="2">根据距离排序</li>
</ul></div><div><p><strong>示例：</strong></p></div><div><p>需求描述：实现对酒店数据按照到你的位置坐标的距离升序排序</p></div><div><p>提示：获取你的位置的经纬度的方式：<a rel="noopener" class="external-link is-unresolved" href="https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat/" target="_self">https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat/</a></p></div><div><p>假设我的位置是：31.034661，121.612282，寻找我周围距离最近的酒店。</p></div><div><p><img alt="image-20210721200214690" src="https://i0.hdslb.com/bfs/album/cb0c2be1367e1e7c58da8b26bd49da6bf4b7bab0.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="2.2.分页" class="heading" id="2.2.分页"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.分页</h2><div class="heading-children"><div><p>elasticsearch 默认情况下只返回top10的数据。而如果要查询更多数据就需要修改分页参数了。elasticsearch中通过修改from、size参数来控制要返回的分页结果：</p></div><div><ul>
<li data-line="0">from：从第几个文档开始</li>
<li data-line="1">size：总共查询几个文档</li>
</ul></div><div><p>类似于mysql中的<code>limit ?, ?</code></p></div><div class="heading-wrapper"><h3 data-heading="2.2.1.基本的分页" class="heading" id="2.2.1.基本的分页"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.1.基本的分页</h3><div class="heading-children"><div><p>分页的基本语法如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 分页开始的位置，默认为0</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 期望获取的文档总数</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="2.2.2.深度分页问题⭐️" class="heading" id="2.2.2.深度分页问题⭐️"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.2.深度分页问题⭐️</h3><div class="heading-children"><div><p>现在，我要查询990~1000的数据，查询逻辑要这么写：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">990</span><span class="token punctuation">,</span> <span class="token comment">// 分页开始的位置，默认为0</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 期望获取的文档总数</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>这里是查询990开始的数据，也就是 第990~第1000条 数据。</p></div><div><p>不过，elasticsearch内部分页时，必须先查询 0~1000条，然后截取其中的990 ~ 1000的这10条：</p></div><div><p><img alt="image-20210721200643029" src="https://i0.hdslb.com/bfs/album/3421d9de088f3a1df5d861720ec64082c5d25e86.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>查询TOP1000，如果es是单点模式，这并无太大影响。</p></div><div><p>但是elasticsearch将来一定是集群，例如我集群有5个节点，我要查询TOP1000的数据，并不是每个节点查询200条就可以了。</p></div><div><p>因为节点A的TOP200，在另一个节点可能排到10000名以外了。</p></div><div><p>因此要想获取整个集群的TOP1000，必须先查询出每个节点的TOP1000，汇总结果后，重新排名，重新截取TOP1000。</p></div><div><p><img alt="image-20210721201003229" src="https://i0.hdslb.com/bfs/album/d9941f02e2fdcb56997519dda7f45146cfa6e762.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>那如果我要查询9900~10000的数据呢？是不是要先查询TOP10000呢？那每个节点都要查询10000条？汇总到内存中？</p></div><div><p>当查询分页深度较大时，汇总数据过多，对内存和CPU会产生非常大的压力，因此elasticsearch会禁止from+ size 超过10000的请求。</p></div><div><p>针对深度分页，ES提供了两种解决方案，<a data-tooltip-position="top" aria-label="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html" rel="noopener" class="external-link is-unresolved" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html" target="_self">官方文档</a>：</p></div><div><ul>
<li data-line="0">search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。（移动app的无限下拉）</li>
<li data-line="1">scroll：原理将排序后的文档id形成快照，保存在内存。官方已经不推荐使用。</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="2.2.3.小结" class="heading" id="2.2.3.小结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.3.小结</h3><div class="heading-children"><div><p>分页查询的常见实现方案以及优缺点：</p></div><div><ul>
<li data-line="0"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><code>from + size</code>：</p>
<ul>
<li data-line="1">优点：支持随机翻页</li>
<li data-line="2">缺点：深度分页问题，默认查询上限（from + size）是10000</li>
<li data-line="3">场景：百度、京东、谷歌、淘宝这样的随机翻页搜索</li>
</ul>
</li>
<li data-line="4"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><code>after search</code>：</p>
<ul>
<li data-line="5">优点：没有查询上限（单次查询的size不超过10000）</li>
<li data-line="6">缺点：只能向后逐页查询，不支持随机翻页</li>
<li data-line="7">场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</li>
</ul>
</li>
<li data-line="9"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><code>scroll</code>：</p>
<ul>
<li data-line="10">优点：没有查询上限（单次查询的size不超过10000）</li>
<li data-line="11">缺点：会有额外内存消耗，并且搜索结果是非实时的</li>
<li data-line="12">场景：海量数据的获取和迁移。从ES7.1开始不推荐，建议用 after search方案。</li>
</ul>
</li>
</ul></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="2.3.高亮" class="heading" id="2.3.高亮"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.高亮</h2><div class="heading-children"><div class="heading-wrapper"><h3 data-heading="2.3.1.高亮原理" class="heading" id="2.3.1.高亮原理"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.1.高亮原理</h3><div class="heading-children"><div><p>什么是高亮显示呢？</p></div><div><p>我们在百度，京东搜索时，关键字会变成红色，比较醒目，这叫高亮显示：</p></div><div><p><img alt="image-20210721202705030" src="https://i0.hdslb.com/bfs/album/28876dc75c7b35cc7c3aad40d308bf7c2f070fd9.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>高亮显示的实现分为两步：</p></div><div><ul>
<li data-line="0">1）给文档中的所有关键字都添加一个标签，例如<code>&lt;em&gt;</code>标签</li>
<li data-line="1">2）页面给<code>&lt;em&gt;</code>标签编写CSS样式</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="2.3.2.实现高亮" class="heading" id="2.3.2.实现高亮"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.2.实现高亮</h3><div class="heading-children"><div><p><strong>高亮的语法</strong>：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span> <span class="token comment">// 查询条件，高亮一定要使用全文检索查询</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 指定要高亮的字段</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;em&gt;"</span><span class="token punctuation">,</span>  <span class="token comment">// 用来标记高亮字段的前置标签</span>
        <span class="token property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/em&gt;"</span> <span class="token comment">// 用来标记高亮字段的后置标签</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p><strong>注意：</strong></p></div><div><ul>
<li data-line="0">高亮是对关键字高亮，因此<strong>搜索条件必须带有关键字</strong>，而不能是范围这样的查询。</li>
<li data-line="1">默认情况下，<strong>高亮的字段，必须与搜索指定的字段一致</strong>，否则无法高亮</li>
<li data-line="2">如果要对非搜索字段高亮，则需要添加一个属性：required_field_match=false</li>
</ul></div><div><blockquote>
<p>像搜索字段为all字段的话，高亮字段就需要添加属性required_field_match=false</p>
</blockquote></div><div><p><strong>示例</strong>：</p></div><div><p><img alt="image-20210721203349633" src="https://i0.hdslb.com/bfs/album/b1589fe5f209d7f06ac38bce4cda745923cb82bd.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="2.4.总结" class="heading" id="2.4.总结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.总结</h2><div class="heading-children"><div><p>查询的DSL是一个大的JSON对象，包含下列属性：</p></div><div><ul>
<li data-line="0">query：查询条件</li>
<li data-line="1">from和size：分页条件</li>
<li data-line="2">sort：排序条件</li>
<li data-line="3">highlight：高亮条件</li>
</ul></div><div><p>示例：</p></div><div><p><img alt="image-20210721203657850" src="https://i0.hdslb.com/bfs/album/395b11848b92bca024305ca7b1fcf42f9d5dfbd0.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="3.RestClient查询文档" class="heading" id="3.RestClient查询文档">3.RestClient查询文档</h1><div class="heading-children"><div><p>文档的查询同样适用昨天学习的 RestHighLevelClient对象，基本步骤包括：</p></div><div><ul>
<li data-line="0">1）准备Request对象</li>
<li data-line="1">2）准备请求参数</li>
<li data-line="2">3）发起请求</li>
<li data-line="3">4）解析响应</li>
</ul></div><div class="heading-wrapper"><h2 data-heading="3.1.快速入门⭐️" class="heading" id="3.1.快速入门⭐️"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.快速入门⭐️</h2><div class="heading-children"><div><p>我们以match_all查询为例</p></div><div class="heading-wrapper"><h3 data-heading="3.1.1.发起查询请求" class="heading" id="3.1.1.发起查询请求"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.1.发起查询请求</h3><div class="heading-children"><div><p><img alt="image-20210721203950559" src="https://i0.hdslb.com/bfs/album/a2438cc8d96435ddc3fc25569f827b449c74ef39.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>代码解读：</p></div><div><ul>
<li data-line="0">
<p>第一步，创建<code>SearchRequest</code>对象，指定索引库名</p>
</li>
<li data-line="2"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p>第二步，利用<code>request.source()</code>构建DSL，DSL中可以包含查询、分页、排序、高亮等</p>
<ul>
<li data-line="3"><code>query()</code>：代表查询条件，利用<code>QueryBuilders.matchAllQuery()</code>构建一个match_all查询的DSL</li>
</ul>
</li>
<li data-line="4">
<p>第三步，利用client.search()发送请求，得到响应</p>
</li>
</ul></div><div><p>这里关键的API有两个，一个是<code>request.source()</code>，其中包含了查询、排序、分页、高亮等所有功能：</p></div><div><p><img alt="image-20210721215640790" src="https://i0.hdslb.com/bfs/album/b0d1cf9aa447ff37ffff8d7d56c11cc18a647751.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>另一个是<code>QueryBuilders</code>，其中包含match、term、function_score、bool等各种查询：</p></div><div><p><img alt="image-20210721215729236" src="https://i0.hdslb.com/bfs/album/6510137deec5fc0211a6e48c210062940dd24b86.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="3.1.2.解析响应" class="heading" id="3.1.2.解析响应"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.2.解析响应</h3><div class="heading-children"><div><p>响应结果的解析：</p></div><div><p><img alt="image-20210721214221057" src="https://i0.hdslb.com/bfs/album/a05a61f6a99df73d9bad42f5083d531ad343c415.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>elasticsearch返回的结果是一个JSON字符串，结构包含：</p></div><div><ul>
<li data-line="0"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><code>hits</code>：命中的结果
<ul>
<li data-line="1"><code>total</code>：总条数，其中的value是具体的总条数值</li>
<li data-line="2"><code>max_score</code>：所有结果中得分最高的文档的相关性算分</li>
<li data-line="3"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><code>hits</code>：搜索结果的文档数组，其中的每个文档都是一个json对象
<ul>
<li data-line="4"><code>_source</code>：文档中的原始数据，也是json对象</li>
</ul>
</li>
</ul>
</li>
</ul></div><div><p>因此，我们解析响应结果，就是逐层解析JSON字符串，流程如下：</p></div><div><ul>
<li data-line="0"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><code>SearchHits</code>：通过response.getHits()获取，就是JSON中的最外层的hits，代表命中的结果
<ul>
<li data-line="1"><code>SearchHits#getTotalHits().value</code>：获取总条数信息</li>
<li data-line="2"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><code>SearchHits#getHits()</code>：获取SearchHit数组，也就是文档数组
<ul>
<li data-line="3"><code>SearchHit#getSourceAsString()</code>：获取文档结果中的_source，也就是原始的json文档数据</li>
</ul>
</li>
</ul>
</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="3.1.3.完整代码" class="heading" id="3.1.3.完整代码"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.3.完整代码</h3><div class="heading-children"><div><p>完整代码如下：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testMatchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.1.获取总条数</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> total <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.2.文档数组</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.3.遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取文档source</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 反序列化</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc = "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="3.1.4.小结" class="heading" id="3.1.4.小结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.4.小结</h3><div class="heading-children"><div><p>查询的基本步骤是：</p></div><div><ol>
<li data-line="0">
<p>创建SearchRequest对象</p>
</li>
<li data-line="2">
<p>准备Request.source()，也就是DSL。</p>
<p>① QueryBuilders来构建查询条件</p>
<p>② 传入Request.source() 的 query() 方法</p>
</li>
<li data-line="8">
<p>发送请求，得到结果</p>
</li>
<li data-line="10">
<p>解析结果（参考JSON结果，从外到内，逐层解析）</p>
</li>
</ol></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="3.2.match查询" class="heading" id="3.2.match查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.match查询</h2><div class="heading-children"><div><p>全文检索的match和multi_match查询与match_all的API基本一致。差别是查询条件，也就是query的部分。</p></div><div><p><img alt="image-20210721215923060" src="https://i0.hdslb.com/bfs/album/127732d080be65a3e4ffdf5c36f5608edb709f67.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div><div><p>因此，Java代码上的差异主要是request.source().query()中的参数了。同样是利用QueryBuilders提供的方法：</p></div><div><p><img alt="image-20210721215843099" src="https://i0.hdslb.com/bfs/album/e76b04ee4cc86710380a45cfd5b55866c29bf29e.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div><div><p>而结果解析代码则完全一致，可以抽取并共享。</p></div><div><p>完整代码如下：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h2 data-heading="3.3.精确查询" class="heading" id="3.3.精确查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.3.精确查询</h2><div class="heading-children"><div><p>精确查询主要是两者：</p></div><div><ul>
<li data-line="0">term：词条精确匹配</li>
<li data-line="1">range：范围查询</li>
</ul></div><div><p>与之前的查询相比，差异同样在查询条件，其它都一样。</p></div><div><p>查询条件构造的API如下：</p></div><div><p><img alt="image-20210721220305140" src="https://i0.hdslb.com/bfs/album/06bd83e8e5eabd05a597bdb01e801b05ec2485c8.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div></div></div><div class="heading-wrapper"><h2 data-heading="3.4.布尔查询" class="heading" id="3.4.布尔查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.4.布尔查询</h2><div class="heading-children"><div><p>布尔查询是用must、must_not、filter等方式组合其它查询，代码示例如下：</p></div><div><p><img alt="image-20210721220927286" src="https://i0.hdslb.com/bfs/album/997b928b04a8934df9a4f5f915b1225bc1deec9b.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>可以看到，API与其它查询的差别同样是在查询条件的构建，<strong>QueryBuilders</strong>，结果解析等其他代码完全不变。</p></div><div><p>完整代码如下：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    <span class="token comment">// 2.1.准备BooleanQuery</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.添加term</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> <span class="token string">"杭州"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.3.添加range</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h2 data-heading="3.5.排序、分页" class="heading" id="3.5.排序、分页"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.5.排序、分页</h2><div class="heading-children"><div><p>搜索结果的排序和分页是与query同级的参数，因此同样是使用request.source()来设置。</p></div><div><p>对应的API如下：</p></div><div><p><img alt="image-20210721221121266" src="https://i0.hdslb.com/bfs/album/26bab797d11321f2a0e98c368a39c32609dc62c8.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>完整代码示例：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testPageAndSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 页码，每页大小</span>
    <span class="token keyword">int</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    <span class="token comment">// 2.1.query</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.排序 sort</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span>ASC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.3.分页 from、size</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h2 data-heading="3.6.高亮" class="heading" id="3.6.高亮"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.6.高亮</h2><div class="heading-children"><div><p>高亮的代码与之前代码差异较大，有两点：</p></div><div><ul>
<li data-line="0">查询的DSL：其中除了查询条件，还需要添加高亮条件，同样是与query同级。</li>
<li data-line="1">结果解析：结果除了要解析_source文档数据，还要解析高亮结果</li>
</ul></div><div class="heading-wrapper"><h3 data-heading="3.6.1.高亮请求构建" class="heading" id="3.6.1.高亮请求构建"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.6.1.高亮请求构建</h3><div class="heading-children"><div><p>高亮请求的构建API如下：</p></div><div><p><img alt="image-20210721221744883" src="https://i0.hdslb.com/bfs/album/e925dc41a8c19ff612c10d4bac9644cc63d4453b.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>上述代码省略了查询条件部分，但是大家不要忘了：高亮查询必须使用全文检索查询，并且要有搜索关键字，将来才可以对关键字高亮。</p></div><div><p>完整代码如下：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testHighlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    <span class="token comment">// 2.1.query</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.高亮</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requireFieldMatch</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="3.6.2.高亮结果解析" class="heading" id="3.6.2.高亮结果解析"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.6.2.高亮结果解析</h3><div class="heading-children"><div><p>高亮的结果与查询的文档结果默认是分离的，并不在一起。</p></div><div><p>因此解析高亮的代码需要额外处理：</p></div><div><p><img alt="image-20210721222057212" src="https://i0.hdslb.com/bfs/album/eada6737f697d873f123c94cd7ebb1226dfe5a1d.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>代码解读：</p></div><div><ul>
<li data-line="0">第一步：从结果中获取source。hit.getSourceAsString()，这部分是非高亮结果，json字符串。还需要反序列为HotelDoc对象</li>
<li data-line="1">第二步：获取高亮结果。hit.getHighlightFields()，返回值是一个Map，key是高亮字段名称，值是HighlightField对象，代表高亮值</li>
<li data-line="2">第三步：从map中根据高亮字段名称，获取高亮字段值对象HighlightField</li>
<li data-line="3">第四步：从HighlightField中获取Fragments，并且转为字符串。这部分就是真正的高亮字符串了</li>
<li data-line="4">第五步：用高亮的结果替换HotelDoc中的非高亮结果</li>
</ul></div><div><p>完整代码如下：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.1.获取总条数</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> total <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.2.文档数组</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.3.遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取文档source</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 反序列化</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取高亮结果</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">&gt;</span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 根据字段名获取高亮结果</span>
            <span class="token class-name">HighlightField</span> highlightField <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>highlightField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获取高亮值</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> highlightField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 覆盖非高亮结果</span>
                hotelDoc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc = "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="4.黑马旅游案例" class="heading" id="4.黑马旅游案例">4.黑马旅游案例</h1><div class="heading-children"><div><p>下面，我们通过黑马旅游的案例来实战演练下之前学习的知识。</p></div><div><p>我们实现四部分功能：</p></div><div><ul>
<li data-line="0">酒店搜索和分页</li>
<li data-line="1">酒店结果过滤</li>
<li data-line="2">我周边的酒店</li>
<li data-line="3">酒店竞价排名</li>
</ul></div><div><p>启动我们提供的hotel-demo项目，其默认端口是8089，访问http://localhost:8090，就能看到项目页面了：</p></div><div><p><img alt="image-20210721223159598" src="https://i0.hdslb.com/bfs/album/027bf9a03ef5ecb016254db2508a33fbfdc93817.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div class="heading-wrapper"><h2 data-heading="4.1.酒店搜索和分页" class="heading" id="4.1.酒店搜索和分页"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.酒店搜索和分页</h2><div class="heading-children"><div><p>案例需求：实现黑马旅游的酒店搜索功能，完成关键字搜索和分页</p></div><div class="heading-wrapper"><h3 data-heading="4.1.1.需求分析" class="heading" id="4.1.1.需求分析"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.1.需求分析</h3><div class="heading-children"><div><p>在项目的首页，有一个大大的搜索框，还有分页按钮：</p></div><div><p><img alt="image-20210721223859419" src="https://i0.hdslb.com/bfs/album/21b5f3b3f69e3491e408794b396e126ffb2c3626.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>点击搜索按钮，可以看到浏览器控制台发出了请求：</p></div><div><p><img alt="image-20210721224033789" src="https://i0.hdslb.com/bfs/album/b142c1bcbdb8db4b1beade21a041cc650a010dd0.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>请求参数如下：</p></div><div><p><img alt="image-20210721224112708" src="https://i0.hdslb.com/bfs/album/5b52f66c1451e287c31989066857367aad71f1aa.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>由此可以知道，我们这个请求的信息如下：</p></div><div><ul>
<li data-line="0">请求方式：POST</li>
<li data-line="1">请求路径：/hotel/list</li>
<li data-line="2"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>请求参数：JSON对象，包含4个字段：
<ul>
<li data-line="3">key：搜索关键字</li>
<li data-line="4">page：页码</li>
<li data-line="5">size：每页大小</li>
<li data-line="6">sortBy：排序，目前暂不实现</li>
</ul>
</li>
<li data-line="7"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>返回值：分页查询，需要返回分页结果PageResult，包含两个属性：
<ul>
<li data-line="8"><code>total</code>：总条数</li>
<li data-line="9"><code>List&lt;HotelDoc&gt;</code>：当前页的数据</li>
</ul>
</li>
</ul></div><div><p>因此，我们实现业务的流程如下：</p></div><div><ul>
<li data-line="0">步骤一：定义实体类，接收请求参数的JSON对象</li>
<li data-line="1">步骤二：编写controller，接收页面的请求</li>
<li data-line="2">步骤三：编写业务实现，利用RestHighLevelClient实现搜索、分页</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="4.1.2.定义实体类" class="heading" id="4.1.2.定义实体类"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.2.定义实体类</h3><div class="heading-children"><div><p>实体类有两个，一个是前端的请求参数实体，一个是服务端应该返回的响应结果实体。</p></div><div><p>1）请求参数</p></div><div><p>前端请求的json结构如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"搜索关键字"</span><span class="token punctuation">,</span>
    <span class="token property">"page"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">"sortBy"</span><span class="token operator">:</span> <span class="token string">"default"</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>因此，我们在<code>cn.itcast.hotel.pojo</code>包下定义一个实体类：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestParams</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> page<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> size<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sortBy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>2）返回值</p></div><div><p>分页查询，需要返回分页结果PageResult，包含两个属性：</p></div><div><ul>
<li data-line="0"><code>total</code>：总条数</li>
<li data-line="1"><code>List&lt;HotelDoc&gt;</code>：当前页的数据</li>
</ul></div><div><p>因此，我们在<code>cn.itcast.hotel.pojo</code>中定义返回结果：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> total<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HotelDoc</span><span class="token punctuation">&gt;</span></span> hotels<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> total<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HotelDoc</span><span class="token punctuation">&gt;</span></span> hotels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">=</span> total<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hotels <span class="token operator">=</span> hotels<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="4.1.3.定义controller" class="heading" id="4.1.3.定义controller"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.3.定义controller</h3><div class="heading-children"><div><p>定义一个HotelController，声明查询接口，满足下列要求：</p></div><div><ul>
<li data-line="0">请求方式：Post</li>
<li data-line="1">请求路径：/hotel/list</li>
<li data-line="2">请求参数：对象，类型为RequestParam</li>
<li data-line="3"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>返回值：PageResult，包含两个属性
<ul>
<li data-line="4"><code>Long total</code>：总条数</li>
<li data-line="5"><code>List&lt;HotelDoc&gt; hotels</code>：酒店数据</li>
</ul>
</li>
</ul></div><div><p>因此，我们在<code>cn.itcast.hotel.web</code>中定义HotelController：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/hotel"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>
	<span class="token comment">// 搜索酒店数据</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RequestParams</span> params<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> hotelService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="4.1.4.实现搜索业务" class="heading" id="4.1.4.实现搜索业务"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.4.实现搜索业务</h3><div class="heading-children"><div><p>我们在controller调用了IHotelService，并没有实现该方法，因此下面我们就在IHotelService中定义方法，并且去实现业务逻辑。</p></div><div><p>1）在<code>cn.itcast.hotel.service</code>中的<code>IHotelService</code>接口中定义一个方法：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token doc-comment comment">/**
 * 根据关键字搜索酒店信息
 * <span class="token keyword">@param</span> <span class="token parameter">params</span> 请求参数对象，包含用户输入的关键字 
 * <span class="token keyword">@return</span> 酒店文档列表
 */</span>
<span class="token class-name">PageResult</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">RequestParams</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>2）实现搜索业务，肯定离不开RestHighLevelClient，我们需要把它注册到Spring中作为一个Bean。在<code>cn.itcast.hotel</code>中的<code>HotelDemoApplication</code>中声明这个Bean：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
        <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.150.101:9200"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>3）在<code>cn.itcast.hotel.service.impl</code>中的<code>HotelService</code>中实现search方法：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">RequestParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.准备Request</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.准备DSL</span>
        <span class="token comment">// 2.1.query</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2.2.分页</span>
        <span class="token keyword">int</span> page <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.发送请求</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.解析响应</span>
        <span class="token keyword">return</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 结果解析</span>
<span class="token keyword">private</span> <span class="token class-name">PageResult</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.1.获取总条数</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token comment">// 4.2.文档数组</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.3.遍历</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HotelDoc</span><span class="token punctuation">&gt;</span></span> hotels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取文档source</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 反序列化</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 放入集合</span>
        hotels<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.4.封装返回</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> hotels<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="4.2.酒店结果过滤" class="heading" id="4.2.酒店结果过滤"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.酒店结果过滤</h2><div class="heading-children"><div><p>需求：添加品牌、城市、星级、价格等过滤功能</p></div><div class="heading-wrapper"><h3 data-heading="4.2.1.需求分析" class="heading" id="4.2.1.需求分析"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.1.需求分析</h3><div class="heading-children"><div><p>在页面搜索框下面，会有一些过滤项：</p></div><div><p><img alt="image-20210722091940726" src="https://i0.hdslb.com/bfs/album/ed9232bb01dd190160bfbc6abf50e4aa60627a49.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>传递的参数如图：</p></div><div><p><img alt="image-20210722092051994" src="https://i0.hdslb.com/bfs/album/306feafbe063b7aecc9a320f90a76f4a0bb6bc2b.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div><div><p>包含的过滤条件有：</p></div><div><ul>
<li data-line="0">brand：品牌值</li>
<li data-line="1">city：城市</li>
<li data-line="2">minPrice~maxPrice：价格范围</li>
<li data-line="3">starName：星级</li>
</ul></div><div><p>我们需要做两件事情：</p></div><div><ul>
<li data-line="0">修改请求参数的对象RequestParams，接收上述参数</li>
<li data-line="1">修改业务逻辑，在搜索条件之外，添加一些过滤条件</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="4.2.2.修改实体类" class="heading" id="4.2.2.修改实体类"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.2.修改实体类</h3><div class="heading-children"><div><p>修改在<code>cn.itcast.hotel.pojo</code>包下的实体类RequestParams：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestParams</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> page<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> size<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sortBy<span class="token punctuation">;</span>
    <span class="token comment">// 下面是新增的过滤条件参数</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brand<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> starName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> minPrice<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> maxPrice<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="4.2.3.修改搜索业务" class="heading" id="4.2.3.修改搜索业务"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.3.修改搜索业务</h3><div class="heading-children"><div><p>在HotelService的search方法中，只有一个地方需要修改：requet.source().query( ... )其中的查询条件。</p></div><div><p>在之前的业务中，只有match查询，根据关键字搜索，现在要添加条件过滤，包括：</p></div><div><ul>
<li data-line="0">品牌过滤：是keyword类型，用term查询</li>
<li data-line="1">星级过滤：是keyword类型，用term查询</li>
<li data-line="2">价格过滤：是数值类型，用range查询</li>
<li data-line="3">城市过滤：是keyword类型，用term查询</li>
</ul></div><div><p>多个查询条件组合，肯定是boolean查询来组合：</p></div><div><ul>
<li data-line="0">关键字搜索放到must中，参与算分</li>
<li data-line="1">其它过滤条件放到filter中，不参与算分</li>
</ul></div><div><p>因为条件构建的逻辑比较复杂，这里先封装为一个函数：</p></div><div><p><img alt="image-20210722092935453" src="https://i0.hdslb.com/bfs/album/379afa7c0bcdea96de9e93203de272d8d775fc17.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>buildBasicQuery的代码如下：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildBasicQuery</span><span class="token punctuation">(</span><span class="token class-name">RequestParams</span> params<span class="token punctuation">,</span> <span class="token class-name">SearchRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.构建BooleanQuery</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.关键字搜索</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.城市条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.品牌条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 5.星级条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"starName"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 6.价格</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span><span class="token function">getMaxPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span>
                         <span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getMaxPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 7.放入source</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="4.3.我周边的酒店" class="heading" id="4.3.我周边的酒店"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.我周边的酒店</h2><div class="heading-children"><div><p>需求：我附近的酒店</p></div><div class="heading-wrapper"><h3 data-heading="4.3.1.需求分析" class="heading" id="4.3.1.需求分析"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.1.需求分析</h3><div class="heading-children"><div><p>在酒店列表页的右侧，有一个小地图，点击地图的定位按钮，地图会找到你所在的位置：</p></div><div><p><img alt="image-20210722093414542" src="https://i0.hdslb.com/bfs/album/6d298f2f5994028cdc2dbf9759f0778aaa62e45c.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div><div><p>并且，在前端会发起查询请求，将你的坐标发送到服务端：</p></div><div><p><img alt="image-20210722093642382" src="https://i0.hdslb.com/bfs/album/477197c623a03f4f32e1f6123273354590d37905.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div><div><p>我们要做的事情就是基于这个location坐标，然后按照距离对周围酒店排序。实现思路如下：</p></div><div><ul>
<li data-line="0">修改RequestParams参数，接收location字段</li>
<li data-line="1">修改search方法业务逻辑，如果location有值，添加根据geo_distance排序的功能</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="4.3.2.修改实体类" class="heading" id="4.3.2.修改实体类"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.2.修改实体类</h3><div class="heading-children"><div><p>修改在<code>cn.itcast.hotel.pojo</code>包下的实体类RequestParams：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestParams</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> page<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> size<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sortBy<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brand<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> starName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> minPrice<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> maxPrice<span class="token punctuation">;</span>
    <span class="token comment">// 我当前的地理坐标</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> location<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="4.3.3.距离排序API" class="heading" id="4.3.3.距离排序API"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.3.距离排序API</h3><div class="heading-children"><div><p>我们以前学习过排序功能，包括两种：</p></div><div><ul>
<li data-line="0">普通字段排序</li>
<li data-line="1">地理坐标排序</li>
</ul></div><div><p>我们只讲了普通字段排序对应的java写法。地理坐标排序只学过DSL语法，如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span>  
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"FIELD"</span> <span class="token operator">:</span> <span class="token string">"纬度，经度"</span><span class="token punctuation">,</span>
          <span class="token property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
          <span class="token property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>对应的java代码示例：</p></div><div><p><img alt="image-20210722095227059" src="https://i0.hdslb.com/bfs/album/a1980dcef7f4e1f39f6f646e823eb91e21e7c23c.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="4.3.4.添加距离排序" class="heading" id="4.3.4.添加距离排序"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.4.添加距离排序</h3><div class="heading-children"><div><p>在<code>cn.itcast.hotel.service.impl</code>的<code>HotelService</code>的<code>search</code>方法中，添加一个排序功能：</p></div><div><p><img alt="image-20210722095902314" src="https://i0.hdslb.com/bfs/album/5c11b72e7cfe1e9b4b47f7485f6f3ecf351cb28a.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>完整代码：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">RequestParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.准备Request</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.准备DSL</span>
        <span class="token comment">// 2.1.query</span>
        <span class="token function">buildBasicQuery</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.2.分页</span>
        <span class="token keyword">int</span> page <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.3.排序</span>
        <span class="token class-name">String</span> location <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>location <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>location<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span>
                                  <span class="token punctuation">.</span><span class="token function">geoDistanceSort</span><span class="token punctuation">(</span><span class="token string">"location"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GeoPoint</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                  <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>ASC<span class="token punctuation">)</span>
                                  <span class="token punctuation">.</span><span class="token function">unit</span><span class="token punctuation">(</span><span class="token class-name">DistanceUnit</span><span class="token punctuation">.</span>KILOMETERS<span class="token punctuation">)</span>
                                 <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3.发送请求</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.解析响应</span>
        <span class="token keyword">return</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="4.3.5.排序距离显示" class="heading" id="4.3.5.排序距离显示"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.5.排序距离显示</h3><div class="heading-children"><div><p>重启服务后，测试我的酒店功能：</p></div><div><p><img alt="image-20210722100040674" src="https://i0.hdslb.com/bfs/album/8715cbf6f3663c5f5773d2504d7eec2afe2a3291.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>发现确实可以实现对我附近酒店的排序，不过并没有看到酒店到底距离我多远，这该怎么办？</p></div><div><p>排序完成后，页面还要获取我附近每个酒店的具体<strong>距离</strong>值，这个值在响应结果中是独立的：</p></div><div><p><img alt="image-20210722095648542" src="https://i0.hdslb.com/bfs/album/088d1fa8f6b90824b619dce66cab7bfe72f5389a.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>因此，我们在结果解析阶段，除了解析source部分以外，还要得到sort部分，也就是排序的距离，然后放到响应结果中。</p></div><div><p>我们要做两件事：</p></div><div><ul>
<li data-line="0">修改HotelDoc，添加排序距离字段，用于页面显示</li>
<li data-line="1">修改HotelService类中的handleResponse方法，添加对sort值的获取</li>
</ul></div><div><p>1）修改HotelDoc类，添加距离字段</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelDoc</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> score<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brand<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> starName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> business<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> location<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> pic<span class="token punctuation">;</span>
    <span class="token comment">// 排序时的 距离值</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> distance<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span><span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brand <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>city <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>starName <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>business <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getBusiness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>location <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> hotel<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pic <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code><button class="copy-code-button">复制</button></pre></div><div><p>2）修改HotelService中的handleResponse方法</p></div><div><p><img alt="image-20210722100613966" src="https://i0.hdslb.com/bfs/album/8f3a40ec1754ae4b9125e3abd793fa6f0d507c57.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>重启后测试，发现页面能成功显示距离了：</p></div><div><p><img alt="image-20210722100838604" src="https://i0.hdslb.com/bfs/album/d70e16281d2380ca51cdfe0b000534224cf8247e.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="4.4.酒店竞价排名" class="heading" id="4.4.酒店竞价排名"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.4.酒店竞价排名</h2><div class="heading-children"><div><p>需求：让指定的酒店在搜索结果中排名置顶</p></div><div class="heading-wrapper"><h3 data-heading="4.4.1.需求分析" class="heading" id="4.4.1.需求分析"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.4.1.需求分析</h3><div class="heading-children"><div><p>要让指定酒店在搜索结果中排名置顶，效果如图：</p></div><div><p><img alt="image-20210722100947292" src="https://i0.hdslb.com/bfs/album/34926adea0d79fd93341b480f18f67f478d587b9.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>页面会给指定的酒店添加<strong>广告</strong>标记。</p></div><div><p>那怎样才能让指定的酒店排名置顶呢？</p></div><div><p>我们之前学习过的function_score查询可以影响算分，算分高了，自然排名也就高了。而function_score包含3个要素：</p></div><div><ul>
<li data-line="0">过滤条件：哪些文档要加分</li>
<li data-line="1">算分函数：如何计算function score</li>
<li data-line="2">加权方式：function score 与 query score如何运算</li>
</ul></div><div><p>这里的需求是：让<strong>指定酒店</strong>排名靠前。因此我们需要给这些酒店添加一个标记，这样在过滤条件中就可以<strong>根据这个标记来判断，是否要提高算分</strong>。</p></div><div><p>比如，我们给酒店添加一个字段：isAD，Boolean类型：</p></div><div><ul>
<li data-line="0">true：是广告</li>
<li data-line="1">false：不是广告</li>
</ul></div><div><p>这样function_score包含3个要素就很好确定了：</p></div><div><ul>
<li data-line="0">过滤条件：判断isAD 是否为true</li>
<li data-line="1">算分函数：我们可以用最简单暴力的weight，固定加权值</li>
<li data-line="2">加权方式：可以用默认的相乘，大大提高算分</li>
</ul></div><div><p>因此，业务的实现步骤包括：</p></div><div><ol>
<li data-line="0">
<p>给HotelDoc类添加isAD字段，Boolean类型</p>
</li>
<li data-line="2">
<p>挑选几个你喜欢的酒店，给它的文档数据添加isAD字段，值为true</p>
</li>
<li data-line="4">
<p>修改search方法，添加function score功能，给isAD值为true的酒店增加权重</p>
</li>
</ol></div></div></div><div class="heading-wrapper"><h3 data-heading="4.4.2.修改HotelDoc实体" class="heading" id="4.4.2.修改HotelDoc实体"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.4.2.修改HotelDoc实体</h3><div class="heading-children"><div><p>给<code>cn.itcast.hotel.pojo</code>包下的HotelDoc类添加isAD字段：</p></div><div><p><img alt="image-20210722101908062" src="https://i0.hdslb.com/bfs/album/e202832a6299ee2df81258af6c6a30dfdb0fdba6.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="4.4.3.添加广告标记" class="heading" id="4.4.3.添加广告标记"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.4.3.添加广告标记</h3><div class="heading-children"><div><p>接下来，我们挑几个酒店，添加isAD字段，设置为true：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">POST /hotel/_update/<span class="token number">1902197537</span>
<span class="token punctuation">{</span>
    <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"isAD"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
POST /hotel/_update/<span class="token number">2056126831</span>
<span class="token punctuation">{</span>
    <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"isAD"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
POST /hotel/_update/<span class="token number">1989806195</span>
<span class="token punctuation">{</span>
    <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"isAD"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
POST /hotel/_update/<span class="token number">2056105938</span>
<span class="token punctuation">{</span>
    <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"isAD"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="4.4.4.添加算分函数查询" class="heading" id="4.4.4.添加算分函数查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.4.4.添加算分函数查询</h3><div class="heading-children"><div><p>接下来我们就要修改查询条件了。之前是用的boolean 查询，现在要改成function_socre查询。</p></div><div><p>function_score查询结构如下：</p></div><div><p><img alt="image-20210721191544750" src="https://i0.hdslb.com/bfs/album/af246cc8f9471f1c98396b66c495eff96f745102.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>对应的JavaAPI如下：</p></div><div><p><img alt="image-20210722102850818" src="https://i0.hdslb.com/bfs/album/552c1fea7f9ca75ede7eaafdcde82d1f041e908e.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>我们可以将之前写的boolean查询作为<strong>原始查询</strong>条件放到query中，接下来就是添加<strong>过滤条件</strong>、<strong>算分函数</strong>、<strong>加权模式</strong>了。所以原来的代码依然可以沿用。</p></div><div><p>修改<code>cn.itcast.hotel.service.impl</code>包下的<code>HotelService</code>类中的<code>buildBasicQuery</code>方法，添加算分函数查询：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildBasicQuery</span><span class="token punctuation">(</span><span class="token class-name">RequestParams</span> params<span class="token punctuation">,</span> <span class="token class-name">SearchRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.构建BooleanQuery</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关键字搜索</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 城市条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 品牌条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 星级条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"starName"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 价格</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span><span class="token function">getMaxPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span>
                         <span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getMinPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">getMaxPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.算分控制</span>
    <span class="token class-name">FunctionScoreQueryBuilder</span> functionScoreQuery <span class="token operator">=</span>
        <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">functionScoreQuery</span><span class="token punctuation">(</span>
        <span class="token comment">// 原始查询，相关性算分的查询</span>
        boolQuery<span class="token punctuation">,</span>
        <span class="token comment">// function score的数组</span>
        <span class="token keyword">new</span> <span class="token class-name">FunctionScoreQueryBuilder<span class="token punctuation">.</span>FilterFunctionBuilder</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
            <span class="token comment">// 其中的一个function score 元素</span>
            <span class="token keyword">new</span> <span class="token class-name">FunctionScoreQueryBuilder<span class="token punctuation">.</span>FilterFunctionBuilder</span><span class="token punctuation">(</span>
                <span class="token comment">// 过滤条件</span>
                <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"isAD"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// 算分函数</span>
                <span class="token class-name">ScoreFunctionBuilders</span><span class="token punctuation">.</span><span class="token function">weightFactorFunction</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>functionScoreQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><hr></div><div class="mod-footer"></div></div></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="outline-tree tree-container"><div class="tree-item nav-folder mod-root" data-depth="0"><div class="tree-item-self nav-folder-title"><div class="tree-item-inner nav-folder-title-content">Table Of Contents</div><button class="clickable-icon nav-action-button tree-collapse-all" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-item-children nav-folder-children"><div class="nav-folder-spacer"></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.DSL查询文档" data-path="#1.DSL查询文档"><div class="tree-item-inner heading-link" heading-name="1.DSL查询文档">1.DSL查询文档</div></a><div class="tree-item-children"><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.1.DSL查询分类" data-path="#1.1.DSL查询分类"><div class="tree-item-inner heading-link" heading-name="1.1.DSL查询分类">1.1.DSL查询分类</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.2.全文检索查询" data-path="#1.2.全文检索查询"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.2.全文检索查询">1.2.全文检索查询</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.2.1.使用场景" data-path="#1.2.1.使用场景"><div class="tree-item-inner heading-link" heading-name="1.2.1.使用场景">1.2.1.使用场景</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.2.2.基本语法" data-path="#1.2.2.基本语法"><div class="tree-item-inner heading-link" heading-name="1.2.2.基本语法">1.2.2.基本语法</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.2.3.示例" data-path="#1.2.3.示例"><div class="tree-item-inner heading-link" heading-name="1.2.3.示例">1.2.3.示例</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.2.4.总结" data-path="#1.2.4.总结"><div class="tree-item-inner heading-link" heading-name="1.2.4.总结">1.2.4.总结</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.3.精准查询" data-path="#1.3.精准查询"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.3.精准查询">1.3.精准查询</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.3.1.term查询" data-path="#1.3.1.term查询"><div class="tree-item-inner heading-link" heading-name="1.3.1.term查询">1.3.1.term查询</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.3.2.range查询" data-path="#1.3.2.range查询"><div class="tree-item-inner heading-link" heading-name="1.3.2.range查询">1.3.2.range查询</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.3.3.总结" data-path="#1.3.3.总结"><div class="tree-item-inner heading-link" heading-name="1.3.3.总结">1.3.3.总结</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.4.地理坐标查询" data-path="#1.4.地理坐标查询"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.4.地理坐标查询">1.4.地理坐标查询</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.4.1.矩形范围查询" data-path="#1.4.1.矩形范围查询"><div class="tree-item-inner heading-link" heading-name="1.4.1.矩形范围查询">1.4.1.矩形范围查询</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.4.2.附近查询" data-path="#1.4.2.附近查询"><div class="tree-item-inner heading-link" heading-name="1.4.2.附近查询">1.4.2.附近查询</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.5.复合查询" data-path="#1.5.复合查询"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.5.复合查询">1.5.复合查询</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.5.1.相关性算分" data-path="#1.5.1.相关性算分"><div class="tree-item-inner heading-link" heading-name="1.5.1.相关性算分">1.5.1.相关性算分</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.5.2.算分函数查询" data-path="#1.5.2.算分函数查询"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.5.2.算分函数查询">1.5.2.算分函数查询</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1）语法说明" data-path="#1）语法说明"><div class="tree-item-inner heading-link" heading-name="1）语法说明">1）语法说明</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2）示例" data-path="#2）示例"><div class="tree-item-inner heading-link" heading-name="2）示例">2）示例</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3）小结" data-path="#3）小结"><div class="tree-item-inner heading-link" heading-name="3）小结">3）小结</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1.5.3.布尔查询" data-path="#1.5.3.布尔查询"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.5.3.布尔查询">1.5.3.布尔查询</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#1）语法示例：" data-path="#1）语法示例："><div class="tree-item-inner heading-link" heading-name="1）语法示例：">1）语法示例：</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2）示例" data-path="#2）示例"><div class="tree-item-inner heading-link" heading-name="2）示例">2）示例</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3）小结" data-path="#3）小结"><div class="tree-item-inner heading-link" heading-name="3）小结">3）小结</div></a><div class="tree-item-children"></div></div></div></div></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.搜索结果处理" data-path="#2.搜索结果处理"><div class="tree-item-inner heading-link" heading-name="2.搜索结果处理">2.搜索结果处理</div></a><div class="tree-item-children"><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.1.排序" data-path="#2.1.排序"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="2.1.排序">2.1.排序</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.1.1.普通字段排序" data-path="#2.1.1.普通字段排序"><div class="tree-item-inner heading-link" heading-name="2.1.1.普通字段排序">2.1.1.普通字段排序</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.1.2.地理坐标排序" data-path="#2.1.2.地理坐标排序"><div class="tree-item-inner heading-link" heading-name="2.1.2.地理坐标排序">2.1.2.地理坐标排序</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.2.分页" data-path="#2.2.分页"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="2.2.分页">2.2.分页</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.2.1.基本的分页" data-path="#2.2.1.基本的分页"><div class="tree-item-inner heading-link" heading-name="2.2.1.基本的分页">2.2.1.基本的分页</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.2.2.深度分页问题⭐️" data-path="#2.2.2.深度分页问题⭐️"><div class="tree-item-inner heading-link" heading-name="2.2.2.深度分页问题⭐️">2.2.2.深度分页问题⭐️</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.2.3.小结" data-path="#2.2.3.小结"><div class="tree-item-inner heading-link" heading-name="2.2.3.小结">2.2.3.小结</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.3.高亮" data-path="#2.3.高亮"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="2.3.高亮">2.3.高亮</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.3.1.高亮原理" data-path="#2.3.1.高亮原理"><div class="tree-item-inner heading-link" heading-name="2.3.1.高亮原理">2.3.1.高亮原理</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.3.2.实现高亮" data-path="#2.3.2.实现高亮"><div class="tree-item-inner heading-link" heading-name="2.3.2.实现高亮">2.3.2.实现高亮</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#2.4.总结" data-path="#2.4.总结"><div class="tree-item-inner heading-link" heading-name="2.4.总结">2.4.总结</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.RestClient查询文档" data-path="#3.RestClient查询文档"><div class="tree-item-inner heading-link" heading-name="3.RestClient查询文档">3.RestClient查询文档</div></a><div class="tree-item-children"><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.1.快速入门⭐️" data-path="#3.1.快速入门⭐️"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="3.1.快速入门⭐️">3.1.快速入门⭐️</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.1.1.发起查询请求" data-path="#3.1.1.发起查询请求"><div class="tree-item-inner heading-link" heading-name="3.1.1.发起查询请求">3.1.1.发起查询请求</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.1.2.解析响应" data-path="#3.1.2.解析响应"><div class="tree-item-inner heading-link" heading-name="3.1.2.解析响应">3.1.2.解析响应</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.1.3.完整代码" data-path="#3.1.3.完整代码"><div class="tree-item-inner heading-link" heading-name="3.1.3.完整代码">3.1.3.完整代码</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.1.4.小结" data-path="#3.1.4.小结"><div class="tree-item-inner heading-link" heading-name="3.1.4.小结">3.1.4.小结</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.2.match查询" data-path="#3.2.match查询"><div class="tree-item-inner heading-link" heading-name="3.2.match查询">3.2.match查询</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.3.精确查询" data-path="#3.3.精确查询"><div class="tree-item-inner heading-link" heading-name="3.3.精确查询">3.3.精确查询</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.4.布尔查询" data-path="#3.4.布尔查询"><div class="tree-item-inner heading-link" heading-name="3.4.布尔查询">3.4.布尔查询</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.5.排序、分页" data-path="#3.5.排序、分页"><div class="tree-item-inner heading-link" heading-name="3.5.排序、分页">3.5.排序、分页</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.6.高亮" data-path="#3.6.高亮"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="3.6.高亮">3.6.高亮</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.6.1.高亮请求构建" data-path="#3.6.1.高亮请求构建"><div class="tree-item-inner heading-link" heading-name="3.6.1.高亮请求构建">3.6.1.高亮请求构建</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#3.6.2.高亮结果解析" data-path="#3.6.2.高亮结果解析"><div class="tree-item-inner heading-link" heading-name="3.6.2.高亮结果解析">3.6.2.高亮结果解析</div></a><div class="tree-item-children"></div></div></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.黑马旅游案例" data-path="#4.黑马旅游案例"><div class="tree-item-inner heading-link" heading-name="4.黑马旅游案例">4.黑马旅游案例</div></a><div class="tree-item-children"><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.1.酒店搜索和分页" data-path="#4.1.酒店搜索和分页"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="4.1.酒店搜索和分页">4.1.酒店搜索和分页</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.1.1.需求分析" data-path="#4.1.1.需求分析"><div class="tree-item-inner heading-link" heading-name="4.1.1.需求分析">4.1.1.需求分析</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.1.2.定义实体类" data-path="#4.1.2.定义实体类"><div class="tree-item-inner heading-link" heading-name="4.1.2.定义实体类">4.1.2.定义实体类</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.1.3.定义controller" data-path="#4.1.3.定义controller"><div class="tree-item-inner heading-link" heading-name="4.1.3.定义controller">4.1.3.定义controller</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.1.4.实现搜索业务" data-path="#4.1.4.实现搜索业务"><div class="tree-item-inner heading-link" heading-name="4.1.4.实现搜索业务">4.1.4.实现搜索业务</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.2.酒店结果过滤" data-path="#4.2.酒店结果过滤"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="4.2.酒店结果过滤">4.2.酒店结果过滤</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.2.1.需求分析" data-path="#4.2.1.需求分析"><div class="tree-item-inner heading-link" heading-name="4.2.1.需求分析">4.2.1.需求分析</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.2.2.修改实体类" data-path="#4.2.2.修改实体类"><div class="tree-item-inner heading-link" heading-name="4.2.2.修改实体类">4.2.2.修改实体类</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.2.3.修改搜索业务" data-path="#4.2.3.修改搜索业务"><div class="tree-item-inner heading-link" heading-name="4.2.3.修改搜索业务">4.2.3.修改搜索业务</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.3.我周边的酒店" data-path="#4.3.我周边的酒店"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="4.3.我周边的酒店">4.3.我周边的酒店</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.3.1.需求分析" data-path="#4.3.1.需求分析"><div class="tree-item-inner heading-link" heading-name="4.3.1.需求分析">4.3.1.需求分析</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.3.2.修改实体类" data-path="#4.3.2.修改实体类"><div class="tree-item-inner heading-link" heading-name="4.3.2.修改实体类">4.3.2.修改实体类</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.3.3.距离排序API" data-path="#4.3.3.距离排序API"><div class="tree-item-inner heading-link" heading-name="4.3.3.距离排序API">4.3.3.距离排序API</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.3.4.添加距离排序" data-path="#4.3.4.添加距离排序"><div class="tree-item-inner heading-link" heading-name="4.3.4.添加距离排序">4.3.4.添加距离排序</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.3.5.排序距离显示" data-path="#4.3.5.排序距离显示"><div class="tree-item-inner heading-link" heading-name="4.3.5.排序距离显示">4.3.5.排序距离显示</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.4.酒店竞价排名" data-path="#4.4.酒店竞价排名"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="4.4.酒店竞价排名">4.4.酒店竞价排名</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.4.1.需求分析" data-path="#4.4.1.需求分析"><div class="tree-item-inner heading-link" heading-name="4.4.1.需求分析">4.4.1.需求分析</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.4.2.修改HotelDoc实体" data-path="#4.4.2.修改HotelDoc实体"><div class="tree-item-inner heading-link" heading-name="4.4.2.修改HotelDoc实体">4.4.2.修改HotelDoc实体</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.4.3.添加广告标记" data-path="#4.4.3.添加广告标记"><div class="tree-item-inner heading-link" heading-name="4.4.3.添加广告标记">4.4.3.添加广告标记</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据搜索.html#4.4.4.添加算分函数查询" data-path="#4.4.4.添加算分函数查询"><div class="tree-item-inner heading-link" heading-name="4.4.4.添加算分函数查询">4.4.4.添加算分函数查询</div></a><div class="tree-item-children"></div></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>