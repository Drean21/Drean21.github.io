<!DOCTYPE html> <html><head>
<title>ES：数据分析</title>
<base href="../../..">
<meta id="root-path" root-path="../../..">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
<meta charset="UTF-8">
<meta name="description" content="尘影迹痕 - ES：数据分析">
<meta property="og:title" content="ES：数据分析">
<meta property="og:description" content="尘影迹痕 - ES：数据分析">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.cytl2.eu.org/技术/后端/java/es：数据分析.html">
<meta property="og:image" content="https://i0.hdslb.com/bfs/album/70d8e6970e0a919160ff2475918803fe7236d4fe.png">
<meta property="og:site_name" content="尘影迹痕">
<meta name="author" content="lzy"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://blog.cytl2.eu.org/lib/rss.xml"><include src="lib/html/custom-head-content.html"></include><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.svg"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript><link rel="preload" href="lib/styles/snippets.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/snippets.css"></noscript><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:not(h1,h2,h3,h4,h5,h6):has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(const t of e){let e=t.getAttribute("src");try{const o=await fetch(e);if(!o.ok){console.log("Could not include file: "+e),t?.remove();continue}let l=await o.text(),n=document.createRange().createContextualFragment(l),c=Array.from(n.children);for(let e of c)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);t.before(n),t.remove(),console.log("Included file: "+e)}catch(o){t?.remove(),console.log("Could not include file: "+e,o);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script></head><body class="publish css-settings-manager theme-light show-inline-title h2-underline tbMH-yuan tbMH-qk tbMH-ds-cg tbMH-kd-ncc-jy is-focused"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="1.数据聚合"><p>1.数据聚合</p></h1><div class="heading-wrapper"><div class="heading-children"><div><p><strong><a data-tooltip-position="top" aria-label="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" rel="noopener" class="external-link is-unresolved" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_self">聚合（</a><a data-tooltip-position="top" aria-label="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" rel="noopener" class="external-link is-unresolved" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_self">aggregations</a><a data-tooltip-position="top" aria-label="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" rel="noopener" class="external-link is-unresolved" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_self">）</a></strong>可以让我们极其方便的实现对数据的统计、分析、运算。例如：</p></div><div><ul>
<li data-line="0">什么品牌的手机最受欢迎？</li>
<li data-line="1">这些手机的平均价格、最高价格、最低价格？</li>
<li data-line="2">这些手机每月的销售情况如何？</li>
</ul></div><div><p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p></div><div class="heading-wrapper"><h2 data-heading="1.1.聚合的种类" class="heading" id="1.1.聚合的种类"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.1.聚合的种类</h2><div class="heading-children"><div><p>聚合常见的有三类：</p></div><div><ul>
<li data-line="0"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>桶（Bucket）</strong>聚合：用来对文档做分组</p>
<ul>
<li data-line="1">TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li>
<li data-line="2">Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li>
</ul>
</li>
<li data-line="4"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>度量（Metric）</strong>聚合：用以计算一些值，比如：最大值、最小值、平均值等</p>
<ul>
<li data-line="5">Avg：求平均值</li>
<li data-line="6">Max：求最大值</li>
<li data-line="7">Min：求最小值</li>
<li data-line="8">Stats：同时求max、min、avg、sum等</li>
</ul>
</li>
<li data-line="9">
<p><strong>管道（pipeline）</strong>聚合：其它聚合的结果为基础做聚合</p>
</li>
</ul></div><div><blockquote>
<p><strong>注意：</strong>参加聚合的字段必须是keyword、日期、数值、布尔类型。即不能是可以分词的Text~</p>
</blockquote></div></div></div><div class="heading-wrapper"><h2 data-heading="1.2.DSL实现聚合" class="heading" id="1.2.DSL实现聚合"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.DSL实现聚合</h2><div class="heading-children"><div><p>现在，我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是Bucket聚合。</p></div><div class="heading-wrapper"><h3 data-heading="1.2.1.Bucket聚合语法" class="heading" id="1.2.1.Bucket聚合语法"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.1.Bucket聚合语法</h3><div class="heading-children"><div><p>语法如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// 设置size为0，结果中不包含文档，只包含聚合结果</span>
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 定义聚合</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">//给聚合起个名字</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 聚合的类型，按照品牌值聚合，所以选择term</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span> <span class="token comment">// 参与聚合的字段</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// 希望获取的聚合结果数量</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>结果如图：</p></div><div><p><img alt="image-20210723171948228" src="https://i0.hdslb.com/bfs/album/70d8e6970e0a919160ff2475918803fe7236d4fe.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.2.2.聚合结果排序" class="heading" id="1.2.2.聚合结果排序"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.2.聚合结果排序</h3><div class="heading-children"><div><p>默认情况下，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序。</p></div><div><p>我们可以指定order属性，自定义聚合的排序方式：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span> <span class="token comment">// 按照_count升序排列</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="1.2.3.限定聚合范围" class="heading" id="1.2.3.限定聚合范围"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.3.限定聚合范围</h3><div class="heading-children"><div><p>默认情况下，Bucket聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。</p></div><div><p>我们可以限定要聚合的文档范围，只要添加query条件即可：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">200</span> <span class="token comment">// 只对200元以下的文档聚合</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>这次，聚合得到的品牌明显变少了：</p></div><div><p><img alt="image-20210723172404836" src="https://i0.hdslb.com/bfs/album/ba40ccdabdc4cff1fdaf5bdebc15c0661370f5ba.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.2.4.Metric聚合语法" class="heading" id="1.2.4.Metric聚合语法"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.4.Metric聚合语法</h3><div class="heading-children"><div><p>上节课，我们对酒店按照品牌分组，形成了一个个桶。现在我们需要对桶内的酒店做运算，获取每个品牌的用户评分的min、max、avg等值。</p></div><div><p>这就要用到Metric聚合了，例如stat聚合：就可以获取min、max、avg等结果。</p></div><div><p>语法如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span> 
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 是brands聚合的子聚合，也就是分组后对每组分别计算</span>
        <span class="token property">"score_stats"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 聚合名称</span>
          <span class="token property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 聚合类型，这里stats可以计算min、max、avg等</span>
            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span> <span class="token comment">// 聚合字段，这里是score</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>这次的score_stats聚合是在brandAgg的聚合内部嵌套的子聚合。因为我们需要在每个桶分别计算。</p></div><div><p>另外，我们还可以给聚合结果做个排序，例如按照每个桶的酒店平均分做排序：</p></div><div><p><img alt="image-20210723172917636" src="https://i0.hdslb.com/bfs/album/62d17afc31ea0b3d72cd3072a87a39cca0bad9a6.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.2.5.小结" class="heading" id="1.2.5.小结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.5.小结</h3><div class="heading-children"><div><p>aggs代表聚合，与query同级，此时query的作用是？</p></div><div><ul>
<li data-line="0">限定聚合的的文档范围</li>
</ul></div><div><p>聚合必须的三要素：</p></div><div><ul>
<li data-line="0">聚合名称</li>
<li data-line="1">聚合类型</li>
<li data-line="2">聚合字段</li>
</ul></div><div><p>聚合可配置属性有：</p></div><div><ul>
<li data-line="0">size：指定聚合结果数量</li>
<li data-line="1">order：指定聚合结果排序方式</li>
<li data-line="2">field：指定聚合字段</li>
</ul></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="1.3.RestAPI实现聚合" class="heading" id="1.3.RestAPI实现聚合"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.RestAPI实现聚合</h2><div class="heading-children"><div class="heading-wrapper"><h3 data-heading="1.3.1.API语法" class="heading" id="1.3.1.API语法"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.1.API语法</h3><div class="heading-children"><div><p>聚合条件与query条件同级别，因此需要使用request.source()来指定聚合条件。</p></div><div><p>聚合条件的语法：</p></div><div><p><img alt="image-20210723173057733" src="https://i0.hdslb.com/bfs/album/a6914915e572e96cf2a80d2d94358e758ac8cffc.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>聚合的结果也与查询结果不同，API也比较特殊。不过同样是JSON逐层解析：</p></div><div><p><img alt="image-20210723173215728" src="https://i0.hdslb.com/bfs/album/6c4fda241f4cf306c056daaf0411792508776026.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="1.3.2.业务需求" class="heading" id="1.3.2.业务需求"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.2.业务需求</h3><div class="heading-children"><div><p>需求：搜索页面的品牌、城市等信息不应该是在页面写死，而是通过聚合索引库中的酒店数据得来的：</p></div><div><p><img alt="image-20210723192605566" src="https://i0.hdslb.com/bfs/album/4d3d53a714dbf301b59a7ede300d9785c6e1fa97.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>分析：</p></div><div><p>目前，页面的城市列表、星级列表、品牌列表都是写死的，并不会随着搜索结果的变化而变化。但是用户搜索条件改变时，搜索结果会跟着变化。</p></div><div><p>例如：用户搜索“东方明珠”，那搜索的酒店肯定是在上海东方明珠附近，因此，城市只能是上海，此时城市列表中就不应该显示北京、深圳、杭州这些信息了。</p></div><div><p>也就是说，搜索结果中包含哪些城市，页面就应该列出哪些城市；搜索结果中包含哪些品牌，页面就应该列出哪些品牌。</p></div><div><p>如何得知搜索结果中包含哪些品牌？如何得知搜索结果中包含哪些城市？</p></div><div><p>使用聚合功能，利用Bucket聚合，对搜索结果中的文档基于品牌分组、基于城市分组，就能得知包含哪些品牌、哪些城市了。</p></div><div><p>因为是对搜索结果聚合，因此聚合是<strong>限定范围的聚合</strong>，也就是说聚合的限定条件跟搜索文档的条件一致。</p></div><div><p>查看浏览器可以发现，前端其实已经发出了这样的一个请求：</p></div><div><p><img alt="image-20210723193730799" src="https://i0.hdslb.com/bfs/album/ce450f161bc98e17dbcb70c89dd6b26fe07cc2ce.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>请求<strong>参数与搜索文档的参数完全一致</strong>。</p></div><div><p>返回值类型就是页面要展示的最终结果：</p></div><div><p><img alt="image-20210723203915982" src="https://i0.hdslb.com/bfs/album/02e3e2867c23a25e14acd8e20e628e7b06da778f.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>结果是一个Map结构：</p></div><div><ul>
<li data-line="0">key是字符串，城市、星级、品牌、价格</li>
<li data-line="1">value是集合，例如多个城市的名称</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="1.3.3.业务实现" class="heading" id="1.3.3.业务实现"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.3.业务实现</h3><div class="heading-children"><div><p>在<code>cn.itcast.hotel.web</code>包的<code>HotelController</code>中添加一个方法，遵循下面的要求：</p></div><div><ul>
<li data-line="0">请求方式：<code>POST</code></li>
<li data-line="1">请求路径：<code>/hotel/filters</code></li>
<li data-line="2">请求参数：<code>RequestParams</code>，与搜索文档的参数一致</li>
<li data-line="3">返回值类型：<code>Map&lt;String, List&lt;String&gt;&gt;</code></li>
</ul></div><div><p>代码：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"filters"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RequestParams</span> params<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> hotelService<span class="token punctuation">.</span><span class="token function">getFilters</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>这里调用了IHotelService中的getFilters方法，尚未实现。</p></div><div><p>在<code>cn.itcast.hotel.service.IHotelService</code>中定义新方法：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">filters</span><span class="token punctuation">(</span><span class="token class-name">RequestParams</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>在<code>cn.itcast.hotel.service.impl.HotelService</code>中实现该方法：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">filters</span><span class="token punctuation">(</span><span class="token class-name">RequestParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.准备Request</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.准备DSL</span>
        <span class="token comment">// 2.1.query</span>
        <span class="token function">buildBasicQuery</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.2.设置size</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.3.聚合</span>
        <span class="token function">buildAggregation</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.发出请求</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.解析结果</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.1.根据品牌名称，获取品牌结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> brandList <span class="token operator">=</span> <span class="token function">getAggByName</span><span class="token punctuation">(</span>aggregations<span class="token punctuation">,</span> <span class="token string">"brandAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"品牌"</span><span class="token punctuation">,</span> brandList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2.根据品牌名称，获取品牌结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cityList <span class="token operator">=</span> <span class="token function">getAggByName</span><span class="token punctuation">(</span>aggregations<span class="token punctuation">,</span> <span class="token string">"cityAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"城市"</span><span class="token punctuation">,</span> cityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3.根据品牌名称，获取品牌结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> starList <span class="token operator">=</span> <span class="token function">getAggByName</span><span class="token punctuation">(</span>aggregations<span class="token punctuation">,</span> <span class="token string">"starAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"星级"</span><span class="token punctuation">,</span> starList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildAggregation</span><span class="token punctuation">(</span><span class="token class-name">SearchRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span>
                                 <span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brandAgg"</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
                                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span>
                                 <span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"cityAgg"</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
                                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span>
                                 <span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"starAgg"</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"starName"</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
                                <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAggByName</span><span class="token punctuation">(</span><span class="token class-name">Aggregations</span> aggregations<span class="token punctuation">,</span> <span class="token class-name">String</span> aggName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4.1.根据聚合名称获取聚合结果</span>
    <span class="token class-name">Terms</span> brandTerms <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aggName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.2.获取buckets</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> brandTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.3.遍历</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> brandList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4.4.获取key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        brandList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> brandList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="2.自动补全" class="heading" id="2.自动补全">2.自动补全</h1><div class="heading-children"><div><p>当用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，如图：</p></div><div><p><img alt="image-20210723204936367" src="https://i0.hdslb.com/bfs/album/45966fa7011cd7ddffa1f3af86f3e378ce0ecfcf.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>这种根据用户输入的字母，提示完整词条的功能，就是自动补全了。</p></div><div><p>因为需要根据拼音字母来推断，因此要用到拼音分词功能。</p></div><div class="heading-wrapper"><h2 data-heading="2.1.拼音分词器" class="heading" id="2.1.拼音分词器"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.1.拼音分词器</h2><div class="heading-children"><div><p>要实现根据字母做补全，就必须对文档按照拼音分词。在GitHub上恰好有elasticsearch的拼音分词插件。地址：<a rel="noopener" class="external-link is-unresolved" href="https://github.com/medcl/elasticsearch-analysis-pinyin" target="_self">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p></div><div><p><img alt="image-20210723205932746" src="https://i0.hdslb.com/bfs/album/9f7a4926dfb2c7743c567cfc9c602a8183dcab20.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>课前资料中也提供了拼音分词器的安装包：</p></div><div><p><img alt="image-20210723205722303" src="https://i0.hdslb.com/bfs/album/7303d2bf8ee1393cdc7886d00d96331b0f6ae0b5.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div><div><p>安装方式与IK分词器一样，分三步：</p></div><div><p>​	①解压</p></div><div><p>​	②上传到虚拟机中，elasticsearch的plugin目录</p></div><div><p>​	③重启elasticsearch</p></div><div><p>​	④测试</p></div><div><p>详细安装步骤可以参考IK分词器的安装过程。</p></div><div><p>测试用法如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">POST /_analyze
<span class="token punctuation">{</span>
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"如家酒店还不错"</span><span class="token punctuation">,</span>
  <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>结果：</p></div><div><p><img alt="image-20210723210126506" src="https://i0.hdslb.com/bfs/album/941a0898c206991936423468187f433ca9269a17.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"> </p></div></div></div><div class="heading-wrapper"><h2 data-heading="2.2.自定义分词器⭐️" class="heading" id="2.2.自定义分词器⭐️"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.自定义分词器⭐️</h2><div class="heading-children"><div><p>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。</p></div><div><p><mark>elasticsearch中分词器（analyzer）的组成包含三部分：</mark></p></div><div><ul>
<li data-line="0">character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符</li>
<li data-line="1">tokenizer：将文本按照一定的规则切割成词条（term）。例如keyword，就是不分词；还有ik_smart</li>
<li data-line="2">tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</li>
</ul></div><div><p>文档分词时会依次由这三部分来处理文档：</p></div><div><p>   <img alt="image-20210723210427878" src="https://i0.hdslb.com/bfs/album/25bf7ae888a2efb64be88c4117273c4a139e5e6c.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>声明自定义分词器的语法如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded">PUT /test
<span class="token punctuation">{</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 自定义分词器</span>
        <span class="token property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 分词器名称</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 自定义tokenizer filter</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 过滤器名称</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span> <span class="token comment">// 过滤器类型，这里是pinyin</span>
		  <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>测试：</p></div><div><p><img alt="image-20210723211829150" src="https://i0.hdslb.com/bfs/album/50c247affd3665f89e88df4f0f41ef2edbf3f8ab.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p><strong>总结：</strong></p></div><div><p>如何使用拼音分词器？</p></div><div><ul>
<li data-line="0">
<p>①下载pinyin分词器</p>
</li>
<li data-line="2">
<p>②解压并放到elasticsearch的plugin目录</p>
</li>
<li data-line="4">
<p>③重启即可</p>
</li>
</ul></div><div><p>如何自定义分词器？</p></div><div><ul>
<li data-line="0">
<p>①创建索引库时，在settings中配置，可以包含三部分</p>
</li>
<li data-line="2">
<p>②character filter</p>
</li>
<li data-line="4">
<p>③tokenizer</p>
</li>
<li data-line="6">
<p>④filter</p>
</li>
</ul></div><div><p>拼音分词器注意事项？</p></div><div><ul>
<li data-line="0"><strong>为了避免搜索到同音字，搜索时不要使用拼音分词器</strong></li>
</ul></div></div></div><div class="heading-wrapper"><h2 data-heading="2.3.自动补全查询" class="heading" id="2.3.自动补全查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.自动补全查询</h2><div class="heading-children"><div><p>elasticsearch提供了<a data-tooltip-position="top" aria-label="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html" rel="noopener" class="external-link is-unresolved" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html" target="_self">Completion Suggester</a>查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束：</p></div><div><ul>
<li data-line="0">
<p>参与补全查询的字段必须是completion类型。</p>
</li>
<li data-line="2">
<p>字段的内容一般是用来补全的多个词条形成的数组。</p>
</li>
</ul></div><div><p>比如，一个这样的索引库：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// 创建索引库</span>
PUT test
<span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"title"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>然后插入下面的数据：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// 示例数据</span>
POST test/_doc
<span class="token punctuation">{</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Sony"</span><span class="token punctuation">,</span> <span class="token string">"WH-1000XM3"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
POST test/_doc
<span class="token punctuation">{</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SK-II"</span><span class="token punctuation">,</span> <span class="token string">"PITERA"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
POST test/_doc
<span class="token punctuation">{</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Nintendo"</span><span class="token punctuation">,</span> <span class="token string">"switch"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>查询的DSL语句如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// 自动补全查询</span>
GET /test/_search
<span class="token punctuation">{</span>
  <span class="token property">"suggest"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"title_suggest"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token comment">// 关键字</span>
      <span class="token property">"completion"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token comment">// 补全查询的字段</span>
        <span class="token property">"skip_duplicates"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 跳过重复的</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token comment">// 获取前10条结果</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h2 data-heading="2.4.实现酒店搜索框自动补全" class="heading" id="2.4.实现酒店搜索框自动补全"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.实现酒店搜索框自动补全</h2><div class="heading-children"><div><p>现在，我们的hotel索引库还没有设置拼音分词器，需要修改索引库中的配置。但是我们知道索引库是无法修改的，只能删除然后重新创建。</p></div><div><p>另外，我们需要添加一个字段，用来做自动补全，将brand、suggestion、city等都放进去，作为自动补全的提示。</p></div><div><p>因此，总结一下，我们需要做的事情包括：</p></div><div><ol>
<li data-line="0">
<p>修改hotel索引库结构，设置自定义拼音分词器</p>
</li>
<li data-line="2">
<p>修改索引库的name、all字段，使用自定义分词器</p>
</li>
<li data-line="4">
<p>索引库添加一个新字段suggestion，类型为completion类型，使用自定义的分词器</p>
</li>
<li data-line="6">
<p>给HotelDoc类添加suggestion字段，内容包含brand、business</p>
</li>
<li data-line="8">
<p>重新导入数据到hotel库</p>
</li>
</ol></div><div class="heading-wrapper"><h3 data-heading="2.4.1.修改酒店映射结构" class="heading" id="2.4.1.修改酒店映射结构"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.1.修改酒店映射结构</h3><div class="heading-children"><div><p>代码如下：</p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token comment">// 酒店数据索引库</span>
PUT /hotel
<span class="token punctuation">{</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"text_anlyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"completion_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"text_anlyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"address"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"score"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"brand"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"city"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"starName"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"business"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"location"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"pic"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"all"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"text_anlyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"suggestion"</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span><span class="token punctuation">,</span>
          <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"completion_analyzer"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="2.4.2.修改HotelDoc实体" class="heading" id="2.4.2.修改HotelDoc实体"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.2.修改HotelDoc实体</h3><div class="heading-children"><div><p>HotelDoc中要添加一个字段，用来做自动补全，内容可以是酒店品牌、城市、商圈等信息。按照自动补全字段的要求，最好是这些字段的数组。</p></div><div><p>因此我们在HotelDoc中添加一个suggestion字段，类型为<code>List&lt;String&gt;</code>，然后将brand、city、business等信息放到里面。</p></div><div><p>代码如下：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelDoc</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> score<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brand<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> starName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> business<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> location<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> pic<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> distance<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isAD<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> suggestion<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span><span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brand <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>city <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>starName <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>business <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getBusiness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>location <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> hotel<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pic <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 组装suggestion</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>business<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// business有多个值，需要切割</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>business<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 添加元素</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>suggestion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>suggestion<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>suggestion<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>suggestion <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brand<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>business<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="2.4.3.重新导入" class="heading" id="2.4.3.重新导入"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.3.重新导入</h3><div class="heading-children"><div><p>重新执行之前编写的导入数据功能，可以看到新的酒店数据中包含了suggestion：</p></div><div><p><img alt="image-20210723213546183" src="https://i0.hdslb.com/bfs/album/ad7741a3509d66e1db8cc8d4b8d1d7a734976012.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="2.4.4.自动补全查询的JavaAPI" class="heading" id="2.4.4.自动补全查询的JavaAPI"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.4.自动补全查询的JavaAPI</h3><div class="heading-children"><div><p>之前我们学习了自动补全查询的DSL，而没有学习对应的JavaAPI，这里给出一个示例：</p></div><div><p><img alt="image-20210723213759922" src="https://i0.hdslb.com/bfs/album/aff10e67d7ba2c035da26af096d730240996eb91.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>而自动补全的结果也比较特殊，解析的代码如下：</p></div><div><p><img alt="image-20210723213917524" src="https://i0.hdslb.com/bfs/album/5527424eb0bab9735e7b51713ae9b3d64fc61678.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="2.4.5.实现搜索框自动补全" class="heading" id="2.4.5.实现搜索框自动补全"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.5.实现搜索框自动补全</h3><div class="heading-children"><div><p>查看前端页面，可以发现当我们在输入框键入时，前端会发起ajax请求：</p></div><div><p><img alt="image-20210723214021062" src="https://i0.hdslb.com/bfs/album/5ddeec199376b09ef6cd6f398b38e6016ca86487.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>返回值是补全词条的集合，类型为<code>List&lt;String&gt;</code></p></div><div><p>1）在<code>cn.itcast.hotel.web</code>包下的<code>HotelController</code>中添加新接口，接收新的请求：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSuggestions</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> hotelService<span class="token punctuation">.</span><span class="token function">getSuggestions</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>2）在<code>cn.itcast.hotel.service</code>包下的<code>IhotelService</code>中添加方法：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSuggestions</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>3）在<code>cn.itcast.hotel.service.impl.HotelService</code>中实现该方法：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSuggestions</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.准备Request</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.准备DSL</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suggest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuggestBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSuggestion</span><span class="token punctuation">(</span>
            <span class="token string">"suggestions"</span><span class="token punctuation">,</span>
            <span class="token class-name">SuggestBuilders</span><span class="token punctuation">.</span><span class="token function">completionSuggestion</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">skipDuplicates</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.发起请求</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.解析结果</span>
        <span class="token class-name">Suggest</span> suggest <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getSuggest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.1.根据补全查询名称，获取补全结果</span>
        <span class="token class-name">CompletionSuggestion</span> suggestions <span class="token operator">=</span> suggest<span class="token punctuation">.</span><span class="token function">getSuggestion</span><span class="token punctuation">(</span><span class="token string">"suggestions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2.获取options</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletionSuggestion<span class="token punctuation">.</span>Entry<span class="token punctuation">.</span>Option</span><span class="token punctuation">&gt;</span></span> options <span class="token operator">=</span> suggestions<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3.遍历</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CompletionSuggestion<span class="token punctuation">.</span>Entry<span class="token punctuation">.</span>Option</span> option <span class="token operator">:</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> text <span class="token operator">=</span> option<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="3.数据同步" class="heading" id="3.数据同步">3.数据同步</h1><div class="heading-children"><div><p>elasticsearch中的酒店数据来自于mysql数据库，因此mysql数据发生改变时，elasticsearch也必须跟着改变，这个就是elasticsearch与mysql之间的<strong>数据同步</strong>。</p></div><div><p><img alt="image-20210723214758392" src="https://i0.hdslb.com/bfs/album/613b84b6da281db90164f5d87c1ffaac5cd61124.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div class="heading-wrapper"><h2 data-heading="3.1.思路分析" class="heading" id="3.1.思路分析"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.思路分析</h2><div class="heading-children"><div><p>常见的数据同步方案有三种：</p></div><div><ul>
<li data-line="0">同步调用</li>
<li data-line="1">异步通知</li>
<li data-line="2">监听binlog</li>
</ul></div><div class="heading-wrapper"><h3 data-heading="3.1.1.同步调用" class="heading" id="3.1.1.同步调用"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.1.同步调用</h3><div class="heading-children"><div><p>方案一：同步调用</p></div><div><p><img alt="image-20210723214931869" src="https://i0.hdslb.com/bfs/album/01a998db213985bb9e56c3c8d963e349911ce64b.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>基本步骤如下：</p></div><div><ul>
<li data-line="0">hotel-demo对外提供接口，用来修改elasticsearch中的数据</li>
<li data-line="1">酒店管理服务在完成数据库操作后，直接调用hotel-demo提供的接口，</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="3.1.2.异步通知" class="heading" id="3.1.2.异步通知"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.2.异步通知</h3><div class="heading-children"><div><p>方案二：异步通知</p></div><div><p><img alt="image-20210723215140735" src="https://i0.hdslb.com/bfs/album/b99701946a0de2f3bdfc65e17ccccf487a734fae.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>流程如下：</p></div><div><ul>
<li data-line="0">hotel-admin对mysql数据库数据完成增、删、改后，发送MQ消息</li>
<li data-line="1">hotel-demo监听MQ，接收到消息后完成elasticsearch数据修改</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="3.1.3.监听binlog" class="heading" id="3.1.3.监听binlog"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.3.监听binlog</h3><div class="heading-children"><div><p>方案三：监听binlog</p></div><div><p><img alt="image-20210723215518541" src="https://i0.hdslb.com/bfs/album/5622fdbf25f0648f1749ffbb51ffbec989ad582d.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>流程如下：</p></div><div><ul>
<li data-line="0">给mysql开启binlog功能</li>
<li data-line="1">mysql完成增、删、改操作都会记录在binlog中</li>
<li data-line="2">hotel-demo基于canal监听binlog变化，实时更新elasticsearch中的内容</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="3.1.4.选择" class="heading" id="3.1.4.选择"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.4.选择</h3><div class="heading-children"><div><p>方式一：同步调用❌</p></div><div><ul>
<li data-line="0">优点：实现简单，粗暴</li>
<li data-line="1">缺点：业务耦合度高</li>
</ul></div><div><p>方式二：异步通知</p></div><div><ul>
<li data-line="0">优点：低耦合，实现难度一般</li>
<li data-line="1">缺点：依赖mq的可靠性</li>
</ul></div><div><p>方式三：监听binlog</p></div><div><ul>
<li data-line="0">优点：完全解除服务间耦合</li>
<li data-line="1">缺点：开启binlog增加数据库负担、实现复杂度高</li>
</ul></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="3.2.实现数据同步" class="heading" id="3.2.实现数据同步"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.实现数据同步</h2><div class="heading-children"><div class="heading-wrapper"><h3 data-heading="3.2.1.思路" class="heading" id="3.2.1.思路"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.1.思路</h3><div class="heading-children"><div><p>利用课前资料提供的hotel-admin项目作为酒店管理的微服务。当酒店数据发生增、删、改时，要求对elasticsearch中数据也要完成相同操作。</p></div><div><p>步骤：</p></div><div><ul>
<li data-line="0">
<p>导入课前资料提供的hotel-admin项目，启动并测试酒店数据的CRUD</p>
</li>
<li data-line="2">
<p>声明exchange、queue、RoutingKey</p>
</li>
<li data-line="4">
<p>在hotel-admin中的增、删、改业务中完成消息发送</p>
</li>
<li data-line="6">
<p>在hotel-demo中完成消息监听，并更新elasticsearch中数据</p>
</li>
<li data-line="8">
<p>启动并测试数据同步功能</p>
</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="3.2.2.导入demo" class="heading" id="3.2.2.导入demo"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.2.导入demo</h3><div class="heading-children"><div><p>导入课前资料提供的hotel-admin项目：</p></div><div><p><img alt="image-20210723220237930" src="https://i0.hdslb.com/bfs/album/88c9228f89b1201fbb55c89d9adf3007eb2d41db.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>运行后，访问 http://localhost:8099</p></div><div><p><img alt="image-20210723220354464" src="https://i0.hdslb.com/bfs/album/fa7971c02c7dee5d9308467ed8366fbe69e49fcb.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>其中包含了酒店的CRUD功能：</p></div><div><p><img alt="image-20210723220511090" src="https://i0.hdslb.com/bfs/album/cfc9e620cca32021fcb908320ab93275e2df6e62.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="3.2.3.声明交换机、队列" class="heading" id="3.2.3.声明交换机、队列"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.3.声明交换机、队列</h3><div class="heading-children"><div><p>MQ结构如图：</p></div><div><p><img alt="image-20210723215850307" src="https://i0.hdslb.com/bfs/album/bffd999a3a68a94ef46d1de6108b0aeacd5d6898.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div class="heading-wrapper"><h4 data-heading="1）引入依赖" class="heading" id="1）引入依赖"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1）引入依赖</h4><div class="heading-children"><div><p>在hotel-admin、hotel-demo中引入rabbitmq的依赖：</p></div><div><pre class="language-xml" tabindex="0"><code class="language-xml is-loaded"><span class="token comment">&lt;!--amqp--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h4 data-heading="2）声明队列交换机名称" class="heading" id="2）声明队列交换机名称"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2）声明队列交换机名称</h4><div class="heading-children"><div><p>在hotel-admin和hotel-demo中的<code>cn.itcast.hotel.constatnts</code>包下新建一个类<code>MqConstants</code>：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>constatnts</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConstants</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 交换机
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_EXCHANGE <span class="token operator">=</span> <span class="token string">"hotel.topic"</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 监听新增和修改的队列
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_INSERT_QUEUE <span class="token operator">=</span> <span class="token string">"hotel.insert.queue"</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 监听删除的队列
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_DELETE_QUEUE <span class="token operator">=</span> <span class="token string">"hotel.delete.queue"</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 新增或修改的RoutingKey
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_INSERT_KEY <span class="token operator">=</span> <span class="token string">"hotel.insert"</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 删除的RoutingKey
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_DELETE_KEY <span class="token operator">=</span> <span class="token string">"hotel.delete"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div><div class="heading-wrapper"><h4 data-heading="3）声明队列交换机" class="heading" id="3）声明队列交换机"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3）声明队列交换机</h4><div class="heading-children"><div><p>在hotel-demo中，定义配置类，声明队列、交换机：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>constants<span class="token punctuation">.</span></span><span class="token class-name">MqConstants</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Binding</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">BindingBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Queue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">TopicExchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TopicExchange</span> <span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_QUEUE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_QUEUE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">insertQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deleteQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div></div></div><div class="heading-wrapper"><h3 data-heading="3.2.4.发送MQ消息" class="heading" id="3.2.4.发送MQ消息"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.4.发送MQ消息</h3><div class="heading-children"><div><p>在hotel-admin中的增、删、改业务中分别发送MQ消息：</p></div><div><p><img alt="image-20210723221843816" src="https://i0.hdslb.com/bfs/album/0fe85699a67fb69874881027a4cc5bc5eca767f5.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="3.2.5.接收MQ消息" class="heading" id="3.2.5.接收MQ消息"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.5.接收MQ消息</h3><div class="heading-children"><div><p>hotel-demo接收到MQ消息要做的事情包括：</p></div><div><ul>
<li data-line="0">新增消息：根据传递的hotel的id查询hotel信息，然后新增一条数据到索引库</li>
<li data-line="1">删除消息：根据传递的hotel的id删除索引库中的一条数据</li>
</ul></div><div><p>1）首先在hotel-demo的<code>cn.itcast.hotel.service</code>包下的<code>IHotelService</code>中新增新增、删除业务</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">insertById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>2）给hotel-demo中的<code>cn.itcast.hotel.service.impl</code>包下的HotelService中实现业务：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.准备Request</span>
        <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.发送请求</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 0.根据id查询酒店数据</span>
        <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转换为文档类型</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1.准备Request对象</span>
        <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.准备Json文档</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.发送请求</span>
        client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div><div><p>3）编写监听器</p></div><div><p>在hotel-demo中的<code>cn.itcast.hotel.mq</code>包新增一个类：</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>mq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>constants<span class="token punctuation">.</span></span><span class="token class-name">MqConstants</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IHotelService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 监听酒店新增或修改的业务
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 酒店id
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_QUEUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenHotelInsertOrUpdate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        hotelService<span class="token punctuation">.</span><span class="token function">insertById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 监听酒店删除的业务
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 酒店id
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_QUEUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenHotelDelete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        hotelService<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">复制</button></pre></div></div></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="4.集群" class="heading" id="4.集群">4.集群</h1><div class="heading-children"><div><p>单机的elasticsearch做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p></div><div><ul>
<li data-line="0">海量数据存储问题：将索引库从逻辑上拆分为N个分片（shard），存储到多个节点</li>
<li data-line="1">单点故障问题：将分片数据在不同节点备份（replica ）</li>
</ul></div><div><p><strong>ES集群相关概念</strong>:</p></div><div><ul>
<li data-line="0">
<p>集群（cluster）：一组拥有共同的 cluster name 的 节点。</p>
</li>
<li data-line="2">
<p><font color="red">节点（node)</font>   ：集群中的一个 Elasticearch 实例</p>
</li>
<li data-line="4">
<p><font color="red">分片（shard）</font>：索引可以被拆分为不同的部分进行存储，称为分片。在集群环境下，一个索引的不同分片可以拆分到不同的节点中</p>
<p>解决问题：数据量太大，单点存储量有限的问题。</p>
<p><img alt="image-20200104124440086" src="https://i0.hdslb.com/bfs/album/2575de24c04dfa8c821895bca4369e84c59d11b2.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p>
<blockquote>
<p>此处，我们把数据分成3片：shard0、shard1、shard2</p>
</blockquote>
</li>
<li data-line="12">
<p>主分片（Primary shard）：相对于副本分片的定义。</p>
</li>
<li data-line="14">
<p>副本分片（Replica shard）每个主分片可以有一个或者多个副本，数据和主分片一样。</p>
<p>​	</p>
</li>
</ul></div><div><p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！</p></div><div><p>为了在高可用和成本间寻求平衡，我们可以这样做：</p></div><div><ul>
<li data-line="0">首先对数据分片，存储到不同节点</li>
<li data-line="1">然后对每个分片进行备份，放到对方节点，完成互相备份</li>
</ul></div><div><p>这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p></div><div><p><img alt="image-20200104124551912" src="https://i0.hdslb.com/bfs/album/8335749b6aa42c5332e71e01b3e8989cede8594b.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>现在，每个分片都有1个备份，存储在3个节点：</p></div><div><ul>
<li data-line="0">node0：保存了分片0和1</li>
<li data-line="1">node1：保存了分片0和2</li>
<li data-line="2">node2：保存了分片1和2</li>
</ul></div><div class="heading-wrapper"><h2 data-heading="4.1.搭建ES集群" class="heading" id="4.1.搭建ES集群"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.搭建ES集群</h2><div class="heading-children"><div><p>参考课前资料的文档：</p></div><div><p><a data-href="Elasticsearch的安装、配置以及可视化工具kibana#4 部署es集群" href="技术/后端/java/elasticsearch的安装、配置以及可视化工具kibana.html#4_部署es集群" class="internal-link" target="_self" rel="noopener">Elasticsearch的安装、配置以及可视化工具kibana &gt; 4 部署es集群</a></p></div></div></div><div class="heading-wrapper"><h2 data-heading="4.2.集群脑裂问题" class="heading" id="4.2.集群脑裂问题"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.集群脑裂问题</h2><div class="heading-children"><div class="heading-wrapper"><h3 data-heading="4.2.1.集群职责划分" class="heading" id="4.2.1.集群职责划分"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.1.集群职责划分</h3><div class="heading-children"><div><p>elasticsearch中集群节点有不同的职责划分：</p></div><div><p><img alt="image-20210723223008967" src="https://i0.hdslb.com/bfs/album/9adb20adb76299d14357c48d9a35f7d475840d92.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>默认情况下，集群中的任何一个节点都同时具备上述四种角色。</p></div><div><p>但是真实的集群一定要将集群职责分离：</p></div><div><ul>
<li data-line="0">master节点：对CPU要求高，但是内存要求第</li>
<li data-line="1">data节点：对CPU和内存要求都高</li>
<li data-line="2">coordinating节点：对网络带宽、CPU要求高</li>
</ul></div><div><p>职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。</p></div><div><p>一个典型的es集群职责划分如图：</p></div><div><p><img alt="image-20210723223629142" src="https://i0.hdslb.com/bfs/album/ca49f750d4b1967962978b0f46e254952a52ebb8.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="4.2.2.脑裂问题" class="heading" id="4.2.2.脑裂问题"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.2.脑裂问题</h3><div class="heading-children"><div><p>脑裂是因为集群中的节点失联导致的。</p></div><div><p>例如一个集群中，主节点与其它节点失联：</p></div><div><p><img alt="image-20210723223804995" src="https://i0.hdslb.com/bfs/album/594b195aa27c1628f3f44ea7b7d8a871feaaac74.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>此时，node2和node3认为node1宕机，就会重新选主：</p></div><div><p><img alt="image-20210723223845754" src="https://i0.hdslb.com/bfs/album/25b907108c5b60ee9f79d33157270aee2e3007fd.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异。</p></div><div><p>当网络恢复后，因为集群中有两个master节点，集群状态的不一致，出现脑裂的情况：</p></div><div><p><img alt="image-20210723224000555" src="https://i0.hdslb.com/bfs/album/41c18cf304d1db535082a52ba08e9c9243dea133.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p><strong>解决脑裂的方案是，要求选票超过 ( eligible节点数量 + 1 ）/ 2 才能当选为主，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</strong></p></div><div><p>例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票。node3得到node2和node3的选票，当选为主。node1只有自己1票，没有当选。集群中依然只有1个主节点，没有出现脑裂。</p></div></div></div><div class="heading-wrapper"><h3 data-heading="4.2.3.小结" class="heading" id="4.2.3.小结"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.3.小结</h3><div class="heading-children"><div><p>master eligible节点的作用是什么？</p></div><div><ul>
<li data-line="0">参与集群选主</li>
<li data-line="1">主节点可以管理集群状态、管理分片信息、处理创建和删除索引库的请求</li>
</ul></div><div><p>data节点的作用是什么？</p></div><div><ul>
<li data-line="0">数据的CRUD</li>
</ul></div><div><p>coordinator节点的作用是什么？</p></div><div><ul>
<li data-line="0">
<p>路由请求到其它节点</p>
</li>
<li data-line="2">
<p>合并查询到的结果，返回给用户</p>
</li>
</ul></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="4.3.集群分布式存储" class="heading" id="4.3.集群分布式存储"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.集群分布式存储</h2><div class="heading-children"><div><p>当新增文档时，应该保存到不同分片，保证数据均衡，那么coordinating node如何确定数据该存储到哪个分片呢？</p></div><div class="heading-wrapper"><h3 data-heading="4.3.1.分片存储测试" class="heading" id="4.3.1.分片存储测试"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.1.分片存储测试</h3><div class="heading-children"><div><p>插入三条数据：</p></div><div><p><img alt="image-20210723225006058" src="https://i0.hdslb.com/bfs/album/adfd58e7ca9069eca4fca28f73cb756b9630c2cb.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p><img alt="image-20210723225034637" src="https://i0.hdslb.com/bfs/album/503edc7a912f5a42c62a01dd35682f51424b6398.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p><img alt="image-20210723225112029" src="https://i0.hdslb.com/bfs/album/3feb6f83b1c50a5c1fa0e298199116e60537a0c5.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>测试可以看到，三条数据分别在不同分片：</p></div><div><p><img alt="image-20210723225227928" src="https://i0.hdslb.com/bfs/album/5193e145cd0525940542319687c25ea3e37b3381.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>结果：</p></div><div><p><img alt="image-20210723225342120" src="https://i0.hdslb.com/bfs/album/0d48871f8238f9a7be4ffb2848763da3bd8292b2.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h3 data-heading="4.3.2.分片存储原理" class="heading" id="4.3.2.分片存储原理"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.2.分片存储原理</h3><div class="heading-children"><div><p>elasticsearch会通过hash算法来计算文档应该存储到哪个分片：</p></div><div><p><img alt="image-20210723224354904" src="https://i0.hdslb.com/bfs/album/576cb255c72f7d856c01ec695df1b63d68678e31.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>说明：</p></div><div><ul>
<li data-line="0">_routing默认是文档的id</li>
<li data-line="1">算法与分片数量有关，因此索引库一旦创建，分片数量不能修改！</li>
</ul></div><div><p>新增文档的流程如下：</p></div><div><p><img alt="image-20210723225436084" src="https://i0.hdslb.com/bfs/album/292a4c15362401e79172a3497f923f160f4b37c8.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>解读：</p></div><div><ul>
<li data-line="0">1）新增一个id=1的文档</li>
<li data-line="1">2）对id做hash运算，假如得到的是2，则应该存储到shard-2</li>
<li data-line="2">3）shard-2的主分片在node3节点，将数据路由到node3</li>
<li data-line="3">4）保存文档</li>
<li data-line="4">5）同步给shard-2的副本replica-2，在node2节点</li>
<li data-line="5">6）返回结果给coordinating-node节点</li>
</ul></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="4.4.集群分布式查询" class="heading" id="4.4.集群分布式查询"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.4.集群分布式查询</h2><div class="heading-children"><div><p>elasticsearch的查询分成两个阶段：</p></div><div><ul>
<li data-line="0">
<p>scatter phase：分散阶段，coordinating node会把请求分发到每一个分片</p>
</li>
<li data-line="2">
<p>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</p>
</li>
</ul></div><div><p><img alt="image-20210723225809848" src="https://i0.hdslb.com/bfs/album/b1e76b3772cd1a240c3b500f7c2dc6be436bd3fa.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div></div></div><div class="heading-wrapper"><h2 data-heading="4.5.集群故障转移" class="heading" id="4.5.集群故障转移"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.5.集群故障转移</h2><div class="heading-children"><div><p>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</p></div><div><p>1）例如一个集群结构如图：</p></div><div><p><img alt="image-20210723225945963" src="https://i0.hdslb.com/bfs/album/44079222619aed8a7b0eaac42afca4f84fc35f14.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>现在，node1是主节点，其它两个节点是从节点。</p></div><div><p>2）突然，node1发生了故障：</p></div><div><p><img alt="image-20210723230020574" src="https://i0.hdslb.com/bfs/album/b7dbd30216cb6332c642b37d04f6163f6bec451a.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>宕机后的第一件事，需要重新选主，例如选中了node2：</p></div><div><p><img alt="image-20210723230055974" src="https://i0.hdslb.com/bfs/album/69ce66036b95bb8c28570890262e27f2e0f5bc77.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点。因此需要将node1上的数据迁移到node2、node3：</p></div><div><p><img alt="image-20210723230216642" src="https://i0.hdslb.com/bfs/album/d8164d1786c01e1de8b27d973072651870f3a416.png" referrerpolicy="no-referrer" target="_self" class="is-unresolved"></p></div><div><p>当node1结点恢复正常后，备份数据又会恢复到node1结点，这一切都会由Elasticsearch智能完成所以说它是天生的分布式架构。</p></div><div class="mod-footer"></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="outline-tree tree-container"><div class="tree-item nav-folder mod-root" data-depth="0"><div class="tree-item-self nav-folder-title"><div class="tree-item-inner nav-folder-title-content">Table Of Contents</div><button class="clickable-icon nav-action-button tree-collapse-all" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-item-children nav-folder-children"><div class="nav-folder-spacer"></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.数据聚合" data-path="#1.数据聚合"><div class="tree-item-inner heading-link" heading-name="1.数据聚合">1.数据聚合</div></a><div class="tree-item-children"><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.1.聚合的种类" data-path="#1.1.聚合的种类"><div class="tree-item-inner heading-link" heading-name="1.1.聚合的种类">1.1.聚合的种类</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.2.DSL实现聚合" data-path="#1.2.DSL实现聚合"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.2.DSL实现聚合">1.2.DSL实现聚合</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.2.1.Bucket聚合语法" data-path="#1.2.1.Bucket聚合语法"><div class="tree-item-inner heading-link" heading-name="1.2.1.Bucket聚合语法">1.2.1.Bucket聚合语法</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.2.2.聚合结果排序" data-path="#1.2.2.聚合结果排序"><div class="tree-item-inner heading-link" heading-name="1.2.2.聚合结果排序">1.2.2.聚合结果排序</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.2.3.限定聚合范围" data-path="#1.2.3.限定聚合范围"><div class="tree-item-inner heading-link" heading-name="1.2.3.限定聚合范围">1.2.3.限定聚合范围</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.2.4.Metric聚合语法" data-path="#1.2.4.Metric聚合语法"><div class="tree-item-inner heading-link" heading-name="1.2.4.Metric聚合语法">1.2.4.Metric聚合语法</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.2.5.小结" data-path="#1.2.5.小结"><div class="tree-item-inner heading-link" heading-name="1.2.5.小结">1.2.5.小结</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.3.RestAPI实现聚合" data-path="#1.3.RestAPI实现聚合"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="1.3.RestAPI实现聚合">1.3.RestAPI实现聚合</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.3.1.API语法" data-path="#1.3.1.API语法"><div class="tree-item-inner heading-link" heading-name="1.3.1.API语法">1.3.1.API语法</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.3.2.业务需求" data-path="#1.3.2.业务需求"><div class="tree-item-inner heading-link" heading-name="1.3.2.业务需求">1.3.2.业务需求</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1.3.3.业务实现" data-path="#1.3.3.业务实现"><div class="tree-item-inner heading-link" heading-name="1.3.3.业务实现">1.3.3.业务实现</div></a><div class="tree-item-children"></div></div></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.自动补全" data-path="#2.自动补全"><div class="tree-item-inner heading-link" heading-name="2.自动补全">2.自动补全</div></a><div class="tree-item-children"><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.1.拼音分词器" data-path="#2.1.拼音分词器"><div class="tree-item-inner heading-link" heading-name="2.1.拼音分词器">2.1.拼音分词器</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.2.自定义分词器⭐️" data-path="#2.2.自定义分词器⭐️"><div class="tree-item-inner heading-link" heading-name="2.2.自定义分词器⭐️">2.2.自定义分词器⭐️</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.3.自动补全查询" data-path="#2.3.自动补全查询"><div class="tree-item-inner heading-link" heading-name="2.3.自动补全查询">2.3.自动补全查询</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.4.实现酒店搜索框自动补全" data-path="#2.4.实现酒店搜索框自动补全"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="2.4.实现酒店搜索框自动补全">2.4.实现酒店搜索框自动补全</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.4.1.修改酒店映射结构" data-path="#2.4.1.修改酒店映射结构"><div class="tree-item-inner heading-link" heading-name="2.4.1.修改酒店映射结构">2.4.1.修改酒店映射结构</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.4.2.修改HotelDoc实体" data-path="#2.4.2.修改HotelDoc实体"><div class="tree-item-inner heading-link" heading-name="2.4.2.修改HotelDoc实体">2.4.2.修改HotelDoc实体</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.4.3.重新导入" data-path="#2.4.3.重新导入"><div class="tree-item-inner heading-link" heading-name="2.4.3.重新导入">2.4.3.重新导入</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.4.4.自动补全查询的JavaAPI" data-path="#2.4.4.自动补全查询的JavaAPI"><div class="tree-item-inner heading-link" heading-name="2.4.4.自动补全查询的JavaAPI">2.4.4.自动补全查询的JavaAPI</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2.4.5.实现搜索框自动补全" data-path="#2.4.5.实现搜索框自动补全"><div class="tree-item-inner heading-link" heading-name="2.4.5.实现搜索框自动补全">2.4.5.实现搜索框自动补全</div></a><div class="tree-item-children"></div></div></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.数据同步" data-path="#3.数据同步"><div class="tree-item-inner heading-link" heading-name="3.数据同步">3.数据同步</div></a><div class="tree-item-children"><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.1.思路分析" data-path="#3.1.思路分析"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="3.1.思路分析">3.1.思路分析</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.1.1.同步调用" data-path="#3.1.1.同步调用"><div class="tree-item-inner heading-link" heading-name="3.1.1.同步调用">3.1.1.同步调用</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.1.2.异步通知" data-path="#3.1.2.异步通知"><div class="tree-item-inner heading-link" heading-name="3.1.2.异步通知">3.1.2.异步通知</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.1.3.监听binlog" data-path="#3.1.3.监听binlog"><div class="tree-item-inner heading-link" heading-name="3.1.3.监听binlog">3.1.3.监听binlog</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.1.4.选择" data-path="#3.1.4.选择"><div class="tree-item-inner heading-link" heading-name="3.1.4.选择">3.1.4.选择</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.2.实现数据同步" data-path="#3.2.实现数据同步"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="3.2.实现数据同步">3.2.实现数据同步</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.2.1.思路" data-path="#3.2.1.思路"><div class="tree-item-inner heading-link" heading-name="3.2.1.思路">3.2.1.思路</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.2.2.导入demo" data-path="#3.2.2.导入demo"><div class="tree-item-inner heading-link" heading-name="3.2.2.导入demo">3.2.2.导入demo</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.2.3.声明交换机、队列" data-path="#3.2.3.声明交换机、队列"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="3.2.3.声明交换机、队列">3.2.3.声明交换机、队列</div></a><div class="tree-item-children"><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#1）引入依赖" data-path="#1）引入依赖"><div class="tree-item-inner heading-link" heading-name="1）引入依赖">1）引入依赖</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#2）声明队列交换机名称" data-path="#2）声明队列交换机名称"><div class="tree-item-inner heading-link" heading-name="2）声明队列交换机名称">2）声明队列交换机名称</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3）声明队列交换机" data-path="#3）声明队列交换机"><div class="tree-item-inner heading-link" heading-name="3）声明队列交换机">3）声明队列交换机</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.2.4.发送MQ消息" data-path="#3.2.4.发送MQ消息"><div class="tree-item-inner heading-link" heading-name="3.2.4.发送MQ消息">3.2.4.发送MQ消息</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#3.2.5.接收MQ消息" data-path="#3.2.5.接收MQ消息"><div class="tree-item-inner heading-link" heading-name="3.2.5.接收MQ消息">3.2.5.接收MQ消息</div></a><div class="tree-item-children"></div></div></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.集群" data-path="#4.集群"><div class="tree-item-inner heading-link" heading-name="4.集群">4.集群</div></a><div class="tree-item-children"><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.1.搭建ES集群" data-path="#4.1.搭建ES集群"><div class="tree-item-inner heading-link" heading-name="4.1.搭建ES集群">4.1.搭建ES集群</div></a><div class="tree-item-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.2.集群脑裂问题" data-path="#4.2.集群脑裂问题"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="4.2.集群脑裂问题">4.2.集群脑裂问题</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.2.1.集群职责划分" data-path="#4.2.1.集群职责划分"><div class="tree-item-inner heading-link" heading-name="4.2.1.集群职责划分">4.2.1.集群职责划分</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.2.2.脑裂问题" data-path="#4.2.2.脑裂问题"><div class="tree-item-inner heading-link" heading-name="4.2.2.脑裂问题">4.2.2.脑裂问题</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.2.3.小结" data-path="#4.2.3.小结"><div class="tree-item-inner heading-link" heading-name="4.2.3.小结">4.2.3.小结</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.3.集群分布式存储" data-path="#4.3.集群分布式存储"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><div class="tree-item-inner heading-link" heading-name="4.3.集群分布式存储">4.3.集群分布式存储</div></a><div class="tree-item-children"><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.3.1.分片存储测试" data-path="#4.3.1.分片存储测试"><div class="tree-item-inner heading-link" heading-name="4.3.1.分片存储测试">4.3.1.分片存储测试</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.3.2.分片存储原理" data-path="#4.3.2.分片存储原理"><div class="tree-item-inner heading-link" heading-name="4.3.2.分片存储原理">4.3.2.分片存储原理</div></a><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.4.集群分布式查询" data-path="#4.4.集群分布式查询"><div class="tree-item-inner heading-link" heading-name="4.4.集群分布式查询">4.4.集群分布式查询</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-item-self is-clickable" href="技术/后端/java/es：数据分析.html#4.5.集群故障转移" data-path="#4.5.集群故障转移"><div class="tree-item-inner heading-link" heading-name="4.5.集群故障转移">4.5.集群故障转移</div></a><div class="tree-item-children"></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>